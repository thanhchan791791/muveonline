<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Thu - Chi (Firebase Sync)</title>

  <style>
    /* =========================================
       iOS 17/18 DESIGN SYSTEM
       ========================================= */
    :root {
      --ios-bg: #F2F2F7;
      --ios-card: #FFFFFF;
      --ios-blue: #007AFF;
      --ios-green: #34C759;
      --ios-red: #FF3B30;
      --ios-gray-text: #8E8E93;
      --ios-input-bg: #EEF0F4;
      
      --radius-l: 24px;
      --radius-m: 16px;
      --radius-s: 12px;
      
      --shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.04);
      --shadow-card: 0 2px 12px rgba(0, 0, 0, 0.03);
      --glass: saturate(180%) blur(20px);
      
      --ease-ios: cubic-bezier(0.25, 1, 0.5, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
      background-color: var(--ios-bg);
      color: #000;
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px 24px;
      min-height: 100vh;
      animation: iosFadeIn 0.6s var(--ease-ios);
      position: relative;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
      padding-top: 10px;
    }
    .title {
      font-size: 34px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: #000;
      line-height: 1.1;
    }
    .sub {
      color: var(--ios-gray-text);
      font-size: 15px;
      font-weight: 500;
      margin-top: 4px;
    }
    #dateNow {
      text-transform: capitalize;
      font-weight: 600;
      color: var(--ios-blue);
      background: rgba(0, 122, 255, 0.1);
      padding: 6px 12px;
      border-radius: 20px;
    }

    /* Summary Cards */
    .summary {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      flex: 1;
      background: var(--ios-card);
      border-radius: var(--radius-l);
      padding: 20px;
      box-shadow: var(--shadow-card);
      transition: transform 0.2s var(--ease-ios);
    }
    .card:active { transform: scale(0.97); }
    
    .big-amount {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .small-label {
      font-size: 13px;
      color: var(--ios-gray-text);
      font-weight: 500;
    }
    #totalBalance { color: #000; }
    #totalIncome { color: var(--ios-green); }
    #totalExpense { color: var(--ios-red); }

    /* Action Buttons */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 32px;
    }
    .action-btn {
      border: none;
      padding: 18px;
      border-radius: var(--radius-l);
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s var(--ease-ios), opacity 0.2s;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .action-btn:active { transform: scale(0.96); opacity: 0.9; }
    .action-btn.income { background: var(--ios-green); }
    .action-btn.expense { background: var(--ios-red); }

    /* OVERLAYS */
    .form-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .form-overlay.active { opacity: 1; pointer-events: auto; }

    .form-content {
      width: 90%;
      max-width: 420px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      border-radius: 30px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      transform: translateY(100%) scale(0.9);
      transition: transform 0.4s var(--ease-ios);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .form-overlay.active .form-content { transform: translateY(0) scale(1); }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-shrink: 0;
    }
    .form-title { font-size: 20px; font-weight: 700; }
    .close-btn {
      width: 30px; height: 30px;
      background: rgba(118, 118, 128, 0.12);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      font-size: 20px;
      cursor: pointer;
    }

    /* Form Inputs */
    .form { display: flex; flex-direction: column; gap: 16px; }
    .input label { font-size: 13px; color: var(--ios-gray-text); font-weight: 500; margin-bottom: 8px; display: block; }
    .input input, .input textarea {
      width: 100%; background: var(--ios-card); border: none; padding: 16px;
      border-radius: var(--radius-m); font-size: 17px; color: #000;
    }
    .input input:focus { outline: none; box-shadow: 0 0 0 2px var(--ios-blue); }
    #typeSelect { display: none; }
    
    .controls { display: flex; gap: 12px; margin-top: 10px; }
    .btn { flex: 1; padding: 16px; border-radius: var(--radius-m); font-size: 16px; font-weight: 600; border: none; cursor: pointer; }
    .btn.primary { color: white; }
    .btn.primary.income { background: var(--ios-green); }
    .btn.primary.expense { background: var(--ios-red); }
    .btn.ghost { background: transparent; color: var(--ios-red); }

    /* HISTORY LIST */
    .history { display: flex; flex-direction: column; gap: 12px; padding-bottom: 40px; }
    
    .date-card {
      background: var(--ios-card);
      padding: 16px;
      border-radius: var(--radius-m);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-card);
      animation: slideInUp 0.4s var(--ease-ios);
    }
    .date-info { display: flex; flex-direction: column; gap: 4px; }
    .date-text { font-size: 16px; font-weight: 600; color: #000; }
    .day-sum { font-size: 13px; display: flex; gap: 8px; }
    .sum-in { color: var(--ios-green); }
    .sum-out { color: var(--ios-red); }
    
    .detail-btn {
      background: rgba(0, 122, 255, 0.1);
      color: var(--ios-blue);
      font-size: 14px;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      border: none;
    }

    /* DETAIL LIST (Inside Modal) */
    #detailList {
      overflow-y: auto; 
      padding-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tx-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .tx-item:last-child { border-bottom: none; }
    
    .tx-left { display: flex; flex-direction: column; }
    .tx-note { font-weight: 500; font-size: 15px; }
    .tx-sub { font-size: 12px; color: var(--ios-gray-text); }
    
    .tx-right { display: flex; align-items: center; gap: 12px; }
    .tx-amt { font-weight: 600; font-size: 15px; }
    .tx-amt.income { color: var(--ios-green); }
    .tx-amt.expense { color: #000; }
    
    .del-btn-small {
        color: #FF3B30;
        background: rgba(255, 59, 48, 0.1);
        width: 32px; height: 32px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 18px; cursor: pointer;
        border: none;
    }

    /* Animations */
    @keyframes iosFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .empty { text-align: center; color: var(--ios-gray-text); margin-top: 40px; font-size: 15px; }
    
    /* Loading State */
    #loading { text-align: center; margin-top: 20px; color: var(--ios-blue); font-weight: 500; display: none; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <div>
        <div class="sub" id="dateNow"></div>
        <div class="title">Thu & Chi <span style="font-size: 14px; color: #8E8E93; font-weight: normal;">(Firebase)</span></div>
      </div>
    </div>

    <div class="summary">
      <div class="card">
        <div class="small-label">Số dư</div>
        <div class="big-amount" id="totalBalance">...</div>
      </div>
      <div class="card">
        <div style="display:flex; flex-direction: column; gap: 8px;">
          <div><div class="small-label" style="color:var(--ios-green)">Thu</div><div class="big-amount" id="totalIncome" style="font-size:16px;">0₫</div></div>
          <div style="width: 100%; height: 1px; background: rgba(0,0,0,0.05);"></div>
          <div><div class="small-label" style="color:var(--ios-red)">Chi</div><div class="big-amount" id="totalExpense" style="font-size:16px;">0₫</div></div>
        </div>
      </div>
    </div>

    <div class="action-buttons">
        <button class="action-btn income" onclick="window.showForm('income')"><span>+</span> Thu nhập</button>
        <button class="action-btn expense" onclick="window.showForm('expense')"><span>&minus;</span> Chi tiêu</button>
    </div>

    <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px; margin-left: 4px;">Lịch sử</div>
    <div id="loading">Đang đồng bộ dữ liệu...</div>
    <div class="history" id="historyList"></div>
    <div class="empty" id="emptyState" style="display:none;">Chưa có giao dịch nào.</div>

    <div class="form-overlay" id="formOverlay">
        <div class="form-content">
            <div class="form-header">
                <div class="form-title" id="formTitle">Thêm Giao Dịch</div>
                <span class="close-btn" onclick="window.hideForm()">&times;</span>
            </div>
            <form id="txForm" class="form" onsubmit="return false;">
              <div class="input full"><label>Số tiền</label><input id="amountInput" type="text" placeholder="0" inputmode="numeric" required /></div>
              <div class="input date-input"><label>Ngày giao dịch</label><input id="dateInput" type="date" required /></div>
              <div class="input" style="display:none;"><select id="typeSelect"><option value="expense">Chi</option><option value="income">Thu</option></select></div>
              <input id="categoryInput" type="hidden" value="" />
              <div class="input full"><label>Ghi chú</label><textarea id="noteInput" rows="3" placeholder="Ví dụ: Ăn trưa..."></textarea></div>
              <div class="controls full">
                <button id="addBtn" class="btn primary" type="button">Lưu lại</button>
              </div>
            </form>
        </div>
    </div>

    <div class="form-overlay" id="detailOverlay">
        <div class="form-content">
            <div class="form-header">
                <div class="form-title" id="detailTitle">Chi tiết</div>
                <span class="close-btn" onclick="window.hideDetails()">&times;</span>
            </div>
            <div id="detailList"></div>
        </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB8Wf1_UDl804EDFmEKFE5cZvjJSEfWVg8",
      authDomain: "xedua-86b46.firebaseapp.com",
      databaseURL: "https://xedua-86b46-default-rtdb.firebaseio.com",
      projectId: "xedua-86b46",
      storageBucket: "xedua-86b46.firebasestorage.app",
      messagingSenderId: "769715162274",
      appId: "1:769715162274:web:b85463e0bcffbefa841bfb",
      measurementId: "G-CKV76SMCQ9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const txRef = ref(db, 'transactions');

    // Biến lưu trữ dữ liệu cục bộ sau khi fetch từ DB
    let currentTransactions = [];

    // ======= DOM Elements
    const dateNowEl = document.getElementById('dateNow');
    const formOverlay = document.getElementById('formOverlay');
    const detailOverlay = document.getElementById('detailOverlay');
    const detailListEl = document.getElementById('detailList');
    const detailTitle = document.getElementById('detailTitle');
    const formTitle = document.getElementById('formTitle');
    const amountInput = document.getElementById('amountInput');
    const dateInput = document.getElementById('dateInput');
    const typeSelect = document.getElementById('typeSelect');
    const categoryInput = document.getElementById('categoryInput');
    const noteInput = document.getElementById('noteInput');
    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const historyList = document.getElementById('historyList');
    const emptyState = document.getElementById('emptyState');
    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpenseEl = document.getElementById('totalExpense');
    const totalBalanceEl = document.getElementById('totalBalance');
    const loadingEl = document.getElementById('loading');

    // ======= Date Display
    const now = new Date();
    dateNowEl.textContent = now.toLocaleDateString('vi-VN', { weekday:'short', day:'2-digit', month:'short' });

    // ======= REALTIME DATABASE LISTENER
    loadingEl.style.display = 'block';
    onValue(txRef, (snapshot) => {
        loadingEl.style.display = 'none';
        const data = snapshot.val();
        
        if (data) {
            // Convert Object to Array: {key1: val1, key2: val2} -> [{id: key1, ...val1}, ...]
            currentTransactions = Object.keys(data).map(key => ({
                id: key,
                ...data[key]
            }));
        } else {
            currentTransactions = [];
        }
        
        renderTransactions();
        
        // Nếu đang mở modal chi tiết, cập nhật lại nội dung modal
        if (detailOverlay.classList.contains('active')) {
             // Tìm ngày đang được xem dựa trên title (Cách này hơi thủ công, nhưng đơn giản)
             // Tốt nhất là lưu biến global currentDateView, nhưng để đơn giản ta sẽ dùng logic render lại nếu cần
        }
    });

    // ======= Helper Functions
    function formatCurrency(n){
      if (isNaN(n) || n === null) return '0₫';
      return Number(n).toLocaleString('vi-VN') + '₫';
    }
    function cleanNumber(val) {
        if (!val) return 0;
        return Number(val.toString().replace(/\./g, ''));
    }
    function formatAmountInput(input) {
        const val = input.value.replace(/\D/g, '');
        const number = Number(val);
        input.value = number.toLocaleString('vi-VN').replace(/,/g, '.');
    }

    // ======= Render Logic
    function renderTransactions(){
      historyList.innerHTML = '';
      
      if (!currentTransactions.length){
        emptyState.style.display = 'block';
        totalIncomeEl.textContent = '0₫';
        totalExpenseEl.textContent = '0₫';
        totalBalanceEl.textContent = '0₫';
        return;
      }
      emptyState.style.display = 'none';

      let totalIncome = 0, totalExpense = 0;
      const groups = {};

      currentTransactions.forEach(tx => {
          if(tx.type === 'income') totalIncome += Number(tx.amount);
          else totalExpense += Number(tx.amount);

          const dateKey = tx.date.split('T')[0];
          if (!groups[dateKey]) {
              groups[dateKey] = {
                  date: dateKey,
                  income: 0,
                  expense: 0,
                  txs: []
              };
          }
          if(tx.type === 'income') groups[dateKey].income += Number(tx.amount);
          else groups[dateKey].expense += Number(tx.amount);
          groups[dateKey].txs.push(tx);
      });

      const sortedKeys = Object.keys(groups).sort().reverse();

      sortedKeys.forEach((key, idx) => {
          const group = groups[key];
          const el = document.createElement('div');
          el.className = 'date-card';
          el.style.animationDelay = (idx * 50) + 'ms';

          const dateObj = new Date(group.date);
          const dateDisplay = dateObj.toLocaleDateString('vi-VN', { weekday: 'short', day: '2-digit', month: '2-digit' });

          let sumHtml = '';
          if(group.income > 0) sumHtml += `<span class="sum-in">+${formatCurrency(group.income)}</span>`;
          if(group.expense > 0) sumHtml += `<span class="sum-out">-${formatCurrency(group.expense)}</span>`;

          el.innerHTML = `
            <div class="date-info">
                <div class="date-text">${dateDisplay}</div>
                <div class="day-sum">${sumHtml}</div>
            </div>
            <button class="detail-btn" onclick="window.showDetails('${group.date}')">Chi tiết</button>
          `;
          historyList.appendChild(el);
      });

      totalIncomeEl.textContent = formatCurrency(totalIncome);
      totalExpenseEl.textContent = formatCurrency(totalExpense);
      totalBalanceEl.textContent = formatCurrency(totalIncome - totalExpense);
    }

    // ======= EXPOSE FUNCTIONS TO WINDOW (Because of type="module")
    
    window.showForm = function(type) {
        typeSelect.value = type;
        if (type === 'income') {
            formTitle.textContent = 'Thêm Thu Nhập';
            addBtn.className = 'btn primary income';
        } else {
            formTitle.textContent = 'Thêm Chi Tiêu';
            addBtn.className = 'btn primary expense';
        }
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        formOverlay.classList.add('active');
        amountInput.value = '';
        categoryInput.value = '';
        noteInput.value = '';
        amountInput.focus();
    }

    window.hideForm = function() {
        formOverlay.classList.remove('active');
    }

    window.showDetails = function(dateKey) {
        const dayTxs = currentTransactions.filter(tx => tx.date.startsWith(dateKey));
        
        const d = new Date(dateKey);
        detailTitle.textContent = d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        detailListEl.innerHTML = '';
        
        dayTxs.sort((a, b) => b.amount - a.amount).forEach(tx => {
            const item = document.createElement('div');
            item.className = 'tx-item';
            
            const noteText = tx.note ? tx.note : (tx.type === 'income' ? 'Thu nhập' : 'Chi tiêu');
            const sign = tx.type === 'income' ? '+' : '-';
            const colorClass = tx.type === 'income' ? 'income' : 'expense';

            // Nút xóa sẽ gọi window.deleteTx với ID của firebase
            item.innerHTML = `
                <div class="tx-left">
                    <div class="tx-note">${noteText}</div>
                </div>
                <div class="tx-right">
                    <div class="tx-amt ${colorClass}">${sign}${formatCurrency(tx.amount)}</div>
                </div>
            `;
            detailListEl.appendChild(item);
        });

        detailOverlay.classList.add('active');
    }

    window.hideDetails = function() {
        detailOverlay.classList.remove('active');
    }

    // ======= FIREBASE ACTIONS
    window.deleteTx = function(id, dateKey) {
        if(!confirm('Xóa giao dịch này vĩnh viễn?')) return;
        
        // Xóa trên Firebase
        remove(ref(db, `transactions/${id}`))
            .then(() => {
                // UI tự cập nhật nhờ onValue listener
                // Tuy nhiên cần refresh lại modal chi tiết nếu nó đang mở
                // Ta dùng setTimeout để đợi dữ liệu đồng bộ về (hoặc lọc local tạm)
                setTimeout(() => {
                   const stillHasData = currentTransactions.some(tx => tx.date.startsWith(dateKey));
                   if(stillHasData) window.showDetails(dateKey);
                   else window.hideDetails();
                }, 200);
            })
            .catch(err => alert("Lỗi xóa: " + err.message));
    }

    function addTransaction() {
        const amount = cleanNumber(amountInput.value);
        const type = typeSelect.value;
        const category = categoryInput.value.trim(); 
        const note = noteInput.value.trim();
        const date = dateInput.value;

        if (!amount || amount <= 0 || !date) {
            if(!amount) amountInput.focus();
            else dateInput.focus();
            return;
        }

        const txData = {
            amount: Math.round(amount),
            type, category, note,
            date: new Date(date).toISOString() 
        };

        // Push lên Firebase (Firebase tự tạo Key ID)
        push(txRef, txData)
            .then(() => {
                window.hideForm();
            })
            .catch((error) => {
                alert("Lỗi lưu: " + error.message);
            });
    }

    function clearAllData() {
        if (!confirm('CẢNH BÁO: Hành động này sẽ xóa sạch toàn bộ dữ liệu trên Database. Bạn có chắc không?')) return;
        set(txRef, null); // Set null để xóa toàn bộ node transactions
        window.hideForm();
    }

    // Bind Events trong Module
    addBtn.addEventListener('click', addTransaction);
    clearBtn.addEventListener('click', clearAllData);
    amountInput.addEventListener('input', function(){ formatAmountInput(this); });
    amountInput.addEventListener('keydown', function(e){
      if (e.key === 'Enter') { e.preventDefault(); addTransaction(); }
    });

    // Overlay Click handling
    formOverlay.addEventListener('click', (e) => { if (e.target.id === 'formOverlay') window.hideForm(); });
    detailOverlay.addEventListener('click', (e) => { if (e.target.id === 'detailOverlay') window.hideDetails(); });

  </script>
</body>
</html>
