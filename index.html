
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒêi ƒÉn d·ªõi tuii nh√©e^^</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f2f5;
            overflow: hidden; 
            touch-action: manipulation;
        }

        /* iOS Glassmorphism Container */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* Screen Transitions */
        .screen {
            display: none;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .screen.active {
            display: flex;
            opacity: 1;
            transform: scale(1);
        }

        /* Button Animations */
        .btn-bounce:active {
            transform: scale(0.95);
        }

        /* Food Grid Selection */
        .food-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent; /* Ensure border space is always reserved */
        }
        .food-item.selected {
            border-color: #f43f5e;
            background-color: #fff1f2;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(244, 63, 94, 0.2);
        }

        /* Custom scrollbar for better feel */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }
        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-pink-100 to-indigo-100 relative">

    <!-- Main Container -->
    <div class="glass-panel w-full max-w-[380px] h-[90vh] max-h-[800px] rounded-[35px] relative overflow-hidden flex flex-col shadow-2xl">
        
        <!-- Fake Header -->
        <div class="h-14 w-full flex justify-between items-center px-6 pt-2 text-gray-800 z-10">
            <span class="font-bold text-sm tracking-wide">Love.iOS</span>
            <div class="flex gap-1.5 text-xs">
                <i class="fa-solid fa-signal"></i>
                <i class="fa-solid fa-wifi"></i>
                <i class="fa-solid fa-battery-full"></i>
            </div>
        </div>

        <!-- SCREEN 1: INTRO -->
        <div id="screen-1" class="screen active flex-col h-full items-center justify-center px-6 pb-20 text-center">
            <div class="w-28 h-28 bg-white rounded-full flex items-center justify-center shadow-lg mb-6 animate-bounce">
                <span class="text-5xl">üíå</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Hello ƒë·∫±ng ·∫•y!</h1>
            <p class="text-gray-500 mb-8 text-sm">T·ªõ c√≥ m·ªôt c√¢u h·ªèi r·∫•t quan tr·ªçng c·∫ßn c√¢u tr·∫£ l·ªùi ngay l·∫≠p t·ª©c...</p>
            <button onclick="nextScreen(2)" class="btn-bounce bg-black text-white w-full py-3.5 rounded-2xl font-semibold shadow-lg">
                Xem c√¢u h·ªèi
            </button>
        </div>

        <!-- SCREEN 2: THE QUESTION & BUTTONS -->
        <div id="screen-2" class="screen flex-col h-full relative px-6 pb-8 pt-4">
            <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExcDdtb2p5M3c5ZnI5bm15bWx5bWx5bWx5bWx5bWx5bWx5/Lq0h93752f6J9tijvr/giphy.gif" 
                 class="w-full h-44 object-cover rounded-2xl shadow-sm mb-6" alt="Cute Cat GIF">
            
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 leading-tight">Khi n√†o off ƒëi ƒÉn d·ªõi tui nh√©ü•∞</h2>
                <p class="text-gray-400 text-xs mt-2">ƒê·ª´ng t·ª´ ch·ªëi t·∫•m l√≤ng n√†y m√† :(</p>
            </div>

            <!-- Area for buttons -->
            <div class="w-full flex-1 flex flex-col justify-end items-center pb-10">
                <!-- YES BUTTON -->
                <button onclick="acceptLove()" class="btn-bounce w-full py-4 bg-rose-500 text-white rounded-2xl font-bold text-xl shadow-rose-300 shadow-lg z-20 mb-3">
                    Oke ƒëi lu√¥n! ‚ù§Ô∏è
                </button>

                <!-- NO BUTTON (Disappears permanently when clicked/touched) -->
                <button id="noBtn" 
                        onclick="rejectAndDisappear(event)"
                        ontouchstart="rejectAndDisappear(event)" 
                        class="btn-bounce w-full py-3 bg-gray-200 text-gray-500 rounded-2xl text-sm font-semibold shadow-md transition-opacity duration-300">
                    T·ª´ Ch·ªëi
                </button>
            </div>
        </div>

        <!-- SCREEN 3: MENU -->
        <div id="screen-3" class="screen flex-col h-full px-6 pt-4 pb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-1">Yeahh! C·∫≠u th√≠ch ƒÉn g√¨?</h2>
            <p class="text-gray-400 text-xs mb-4">Ch·ªçn m√≥n (ho·∫∑c nhi·ªÅu m√≥n) ƒëi t·ªõ bao t·∫•t!</p>

            <div class="flex-1 flex flex-col overflow-y-auto custom-scroll">
                <div class="grid grid-cols-2 gap-3 pb-4">
                    <!-- Food Item 1 -->
                    <div onclick="toggleFoodSelection(this, 'L·∫©u')" data-food="L·∫©u" class="food-item bg-white p-3 rounded-2xl border border-transparent shadow-sm flex flex-col items-center cursor-pointer transition-all">
                        <span class="text-3xl mb-1">üç≤</span>
                        <span class="font-semibold text-sm text-gray-700">L·∫©u</span>
                    </div>
                    <!-- Food Item 2 -->
                    <div onclick="toggleFoodSelection(this, 'N∆∞·ªõng')" data-food="N∆∞·ªõng" class="food-item bg-white p-3 rounded-2xl border border-transparent shadow-sm flex flex-col items-center cursor-pointer transition-all">
                        <span class="text-3xl mb-1">ü•©</span>
                        <span class="font-semibold text-sm text-gray-700">N∆∞·ªõng</span>
                    </div>
                    <!-- Food Item 3 -->
                    <div onclick="toggleFoodSelection(this, 'Sushi')" data-food="Sushi" class="food-item bg-white p-3 rounded-2xl border border-transparent shadow-sm flex flex-col items-center cursor-pointer transition-all">
                        <span class="text-3xl mb-1">üç£</span>
                        <span class="font-semibold text-sm text-gray-700">Sushi</span>
                    </div>
                    <!-- Food Item 4 -->
                    <div onclick="toggleFoodSelection(this, 'Tr√† S·ªØa')" data-food="Tr√† S·ªØa" class="food-item bg-white p-3 rounded-2xl border border-transparent shadow-sm flex flex-col items-center cursor-pointer transition-all">
                        <span class="text-3xl mb-1">üßã</span>
                        <span class="font-semibold text-sm text-gray-700">Tr√† S·ªØa</span>
                    </div>
                    <!-- Food Item 5 -->
                    <div onclick="toggleFoodSelection(this, 'M√¨ Cay')" data-food="M√¨ Cay" class="food-item bg-white p-3 rounded-2xl border border-transparent shadow-sm flex flex-col items-center cursor-pointer transition-all">
                        <span class="text-3xl mb-1">üçú</span>
                        <span class="font-semibold text-sm text-gray-700">M√¨ Cay</span>
                    </div>
                    <!-- Food Item 6 -->
                    <div onclick="toggleFoodSelection(this, 'ƒÇn ki√™ng/Healthy')" data-food="ƒÇn ki√™ng/Healthy" class="food-item bg-white p-3 rounded-2xl border border-transparent shadow-sm flex flex-col items-center cursor-pointer transition-all">
                        <span class="text-3xl mb-1">ü•ó</span>
                        <span class="font-semibold text-sm text-gray-700">ƒÇn ki√™ng/Healthy</span>
                    </div>
                </div>

                <!-- Custom Food Input -->
                <div class="mb-4 pt-2">
                    <label for="customFood" class="text-xs font-semibold text-gray-600 block mb-1">Ho·∫∑c mu·ªën ƒÉn m√≥n kh√°c?</label>
                    <input type="text" id="customFood" placeholder="Nh·∫≠p t√™n m√≥n ƒÉn tu·ª≥ th√≠ch (v√≠ d·ª•: B√∫n ƒë·∫≠u m·∫Øm t√¥m)" 
                           oninput="checkButtonState()"
                           class="w-full p-3 border border-gray-300 rounded-xl focus:ring-rose-500 focus:border-rose-500 transition-all text-sm shadow-inner">
                </div>
            </div>

            <button id="confirmBtn" onclick="finish()" class="w-full py-3 bg-gray-300 text-white rounded-xl font-bold mt-2 pointer-events-none transition-all">
                Ch·ªçn m√≥n ƒëi ƒë√£
            </button>
        </div>

        <!-- SCREEN 4: DONE -->
        <div id="screen-4" class="screen flex-col h-full items-center justify-center px-6 text-center pb-10">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4 animate-pulse">
                <i class="fa-solid fa-check text-3xl text-green-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Ch·ªët ƒë∆°n!</h2>
            <p class="text-gray-500 text-sm mb-10">Ch·ª•p m√†n h√¨nh l·∫°i g·ª≠i t·ªõ ƒë·ªÉ ch·ªët k√®o nha! ƒê·ª´ng qu√™n c√°c m√≥n ƒë√£ ch·ªçn.</p>

            <div class="bg-white p-4 rounded-2xl shadow-sm w-full mb-6 border border-gray-100">
                <div class="text-left">
                    <span class="text-gray-500 text-base font-medium block mb-2">C√°c m√≥n ƒë√£ ch·ªët:</span>
                    <ul id="resultFoodList" class="space-y-1 text-sm font-semibold text-gray-700">
                        <!-- List of selected food items will be inserted here -->
                    </ul>
                </div>
            </div>

            <p class="text-xs text-gray-400 mt-2">L·ª±a ch·ªçn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c l∆∞u l·∫°i.</p>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- MANDATORY CANVAS GLOBAL VARIABLE INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
            apiKey: "AIzaSyB4S6E-Gl6k5mG57otkF8WUh3iuvqq-pWw",
            authDomain: "member-ffd77.firebaseapp.com",
            databaseURL: "https://member-ffd77-default-rtdb.firebaseio.com",
            projectId: "member-ffd77",
            storageBucket: "member-ffd77.firebasestorage.app",
            messagingSenderId: "375537857518",
            appId: "1:375537857518:web:86449f4419f0ab5f6954ff",
            measurementId: "G-JF4ZDWKBQ5"
        }));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let rtdb; // Realtime Database instance
        let userId = null;
        let isAuthReady = false;
        
        // Global state for multi-selection
        window.selectedFoods = new Set(); 

        async function setupFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                rtdb = getDatabase(app); 
                
                // 1. Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Fallback: Use a unique ID if auth fails
                        userId = crypto.randomUUID(); 
                    }
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
            }
        }

        // --- Core Application Logic ---

        window.nextScreen = function(id) {
            document.getElementById(`screen-${window.current}`).classList.remove('active');
            setTimeout(() => {
                document.getElementById(`screen-${window.current}`).style.display = 'none';
                window.current = id;
                const next = document.getElementById(`screen-${id}`);
                next.style.display = 'flex';
                setTimeout(() => next.classList.add('active'), 50);
            }, 300);
        };
        
        window.current = 1;

        window.rejectAndDisappear = function(event) {
            if (event) {
                event.preventDefault(); 
            }
            
            const noBtn = document.getElementById('noBtn');
            noBtn.style.opacity = '0'; 
            
            setTimeout(() => {
                noBtn.remove();
            }, 300); 
            
            console.log("N√∫t T·ª´ Ch·ªëi ƒë√£ bi·∫øn m·∫•t, ch·ªâ c√≤n c√°ch ƒê·ªìng √ù th√¥i!");
        };

        window.acceptLove = function() {
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#f43f5e', '#fb7185', '#ffe4e6']
            });
            window.nextScreen(3);
        };

        window.toggleFoodSelection = function(el, name) {
            // Toggle selection state
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                window.selectedFoods.delete(name);
            } else {
                el.classList.add('selected');
                window.selectedFoods.add(name);
            }
            checkButtonState();
        };

        window.checkButtonState = function() {
            const btn = document.getElementById('confirmBtn');
            const customFoodInput = document.getElementById('customFood').value.trim();
            
            const hasSelection = window.selectedFoods.size > 0 || customFoodInput.length > 0;
            
            if (hasSelection) {
                btn.classList.remove('bg-gray-300', 'pointer-events-none');
                btn.classList.add('bg-rose-500', 'shadow-lg');
                btn.innerText = `Ch·ªët ${window.selectedFoods.size + (customFoodInput.length > 0 ? 1 : 0)} L·ª±a ch·ªçn`;
            } else {
                btn.classList.add('bg-gray-300', 'pointer-events-none');
                btn.classList.remove('bg-rose-500', 'shadow-lg');
                btn.innerText = `Ch·ªçn m√≥n ƒëi ƒë√£`;
            }
        };


        window.finish = async function() {
            const customFood = document.getElementById('customFood').value.trim();
            const finalChoices = [...window.selectedFoods];
            if (customFood) {
                finalChoices.push(customFood);
            }

            // Render final choices list on screen 4
            const listEl = document.getElementById('resultFoodList');
            listEl.innerHTML = '';
            if (finalChoices.length > 0) {
                finalChoices.forEach(choice => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center gap-2 text-rose-600';
                    listItem.innerHTML = `<i class="fa-solid fa-utensils text-xs"></i><span>${choice}</span>`;
                    listEl.appendChild(listItem);
                });
            } else {
                 listEl.innerHTML = `<li class="text-gray-500 italic">Ch∆∞a c√≥ m√≥n n√†o ƒë∆∞·ª£c ch·ªçn!</li>`;
            }
            

            // --- Firebase Save Logic ---
            if (!isAuthReady || !userId) {
                console.error("Firebase Auth not ready or User ID missing. Data will not be saved yet.");
            } else {
                try {
                    const responseData = {
                        foodChoices: finalChoices, // Save array of choices
                        timestamp: new Date().toISOString(),
                        appId: appId 
                    };
                    
                    // Path: artifacts/{appId}/users/{userId}/invitation_response (Private Data)
                    const path = `artifacts/${appId}/users/${userId}/invitation_response`;
                    await set(ref(rtdb, path), responseData);
                    console.log("Data saved successfully to RTDB:", path);

                } catch (e) {
                    console.error("Failed to save data to RTDB:", e);
                }
            }
            
            // Proceed to next screen and confetti
            window.nextScreen(4);
            confetti({ particleCount: 100, spread: 100, origin: { y: 0.7 } });
        };

        // Initialize Firebase on load
        setupFirebase();
    </script>
</body>
</html>

