<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ẩm thực Buôn Mê - Premium Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #3E2723;
            --gold-accent: #C69C6D;
            --bg-creme: #FAF9F6;
            --ios-blur: rgba(255, 255, 255, 0.85);
            --header-height: 80px;
            --sidebar-width: 125px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-creme);
            color: #2C1B18;
            margin: 0;
        }

        /* --- HEADER --- */
        .restaurant-header {
            height: var(--header-height);
            background: var(--ios-blur);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1100;
            border-bottom: 1px solid rgba(62, 39, 35, 0.08);
        }

        .restaurant-logo {
            height: 48px;
            width: 48px;
            object-fit: contain;
            border-radius: 14px;
            margin-right: 16px;
        }

        .restaurant-name {
            font-weight: 900;
            font-size: 1.4rem;
            color: var(--primary-color);
            margin: 0;
            letter-spacing: -1px;
            text-transform: uppercase;
        }

        /* --- LAYOUT --- */
        .order-container {
            display: flex;
            height: 100vh;
            padding-top: var(--header-height);
            padding-bottom: var(--safe-area-bottom);
        }

        .sidebar {
            width: var(--sidebar-width);
            background: #F2EFE9;
            overflow-y: auto;
            scrollbar-width: none;
            border-right: 1px solid rgba(62, 39, 35, 0.05);
            padding: 10px 8px;
        }
        .sidebar::-webkit-scrollbar { display: none; }

        .nav-link {
            padding: 16px 12px;
            margin-bottom: 12px;
            color: #8D736B;
            text-align: center;
            font-size: 0.82rem;
            font-weight: 600;
            border-radius: 18px;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            border: 1px solid transparent;
        }

        .nav-link.active {
            background: #FFFFFF !important;
            color: var(--primary-color) !important;
            font-weight: 800 !important;
            box-shadow: 0 12px 24px rgba(62, 39, 35, 0.12);
            transform: scale(1.1) translateX(5px);
            border: 1px solid rgba(198, 156, 109, 0.3);
            position: relative;
        }
        
        .nav-link.active::before {
            content: '';
            position: absolute;
            left: -5px; top: 25%; height: 50%; width: 4px;
            background: var(--gold-accent); border-radius: 10px;
        }

        /* --- CONTENT --- */
        .menu-content {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 0 24px;
            -webkit-overflow-scrolling: touch;
        }

        .category-header {
            position: relative;
            font-weight: 900;
            font-size: 2.2rem;
            color: var(--primary-color);
            letter-spacing: -1.5px;
            margin: 30px 0;
        }

        .category-header::after {
            content: '';
            position: absolute;
            bottom: -8px; left: 0;
            width: 60px; height: 6px;
            background: linear-gradient(90deg, var(--gold-accent), transparent);
            border-radius: 10px;
        }

        .food-item {
            display: flex;
            padding: 18px;
            background: #fff;
            border-radius: 28px;
            margin-bottom: 22px;
            box-shadow: 0 12px 30px rgba(62, 39, 35, 0.04);
            transition: all 0.3s ease;
        }

        .food-img {
            width: 100px; height: 100px;
            object-fit: cover; border-radius: 22px;
        }

        .food-detail {
            flex: 1; padding-left: 18px;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .food-name { font-weight: 700; font-size: 1.15rem; color: #2D1B18; }
        .food-price { color: var(--primary-color); font-weight: 800; font-size: 1.25rem; }

        /* --- CONTROLS --- */
        .quantity-control {
            display: flex; align-items: center;
            background: #F5F3F0; border-radius: 25px;
            padding: 4px; gap: 8px;
        }

        .btn-circle {
            width: 36px; height: 36px; border-radius: 50%;
            border: none; background: #fff; color: var(--primary-color);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
        }
        
        .btn-add-fill { background: var(--primary-color); color: #fff; }

        /* --- FLY ANIMATION --- */
        .fly-dot {
            position: fixed;
            width: 25px; height: 25px;
            background: var(--gold-accent);
            border-radius: 50%;
            z-index: 9999;
            pointer-events: none;
            box-shadow: 0 0 15px var(--gold-accent);
            transition: all 1.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* --- FOOTER ICON CART --- */
        .footer-cart-icon {
            position: fixed;
            bottom: calc(30px + var(--safe-area-bottom));
            right: 25px;
            width: 70px;
            height: 70px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            z-index: 2000;
            cursor: pointer;
            opacity: 0;
            transform: translateY(100px) scale(0.5);
            pointer-events: none;
            transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .footer-cart-icon.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* HIỆU ỨNG NHẤP NHÔ (BOUNCE) KHI NHẬN MÓN */
        @keyframes bounce {
            0% { transform: scale(1); }
            30% { transform: scale(1.3); }
            50% { transform: scale(0.9); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .footer-cart-icon.bump {
            animation: bounce 0.5s ease-out;
        }

        .footer-cart-icon i { font-size: 1.8rem; color: #fff; }

        .cart-badge {
            position: absolute;
            top: -5px; right: -5px;
            background: var(--gold-accent);
            color: white;
            font-weight: 800;
            font-size: 0.85rem;
            min-width: 25px; height: 25px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 3px solid var(--primary-color);
        }

        /* --- ORDER SHEET --- */
        .order-sheet {
            position: fixed;
            bottom: -100%; left: 0; right: 0;
            background: #fff;
            border-radius: 35px 35px 0 0;
            z-index: 2100;
            padding: 25px;
            padding-bottom: calc(30px + var(--safe-area-bottom));
            max-height: 85vh;
            overflow-y: auto;
            transition: bottom 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -20px 60px rgba(0,0,0,0.25);
        }
        .order-sheet.open { bottom: 0; }

        .sheet-handle {
            width: 45px; height: 5px; background: #E0E0E0;
            border-radius: 10px; margin: 0 auto 20px;
        }

        .sheet-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 2050;
            backdrop-filter: blur(4px);
            display: none;
        }

        .cart-item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; border-bottom: 1px solid #F8F8F8;
        }

        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: 700; color: #3E2723; font-size: 1.1rem; }
        .cart-item-price { font-size: 0.95rem; color: var(--gold-accent); font-weight: 700; }

        .sheet-footer {
            margin-top: 30px;
            background: #F9F7F2;
            padding: 20px;
            border-radius: 25px;
        }

        .btn-confirm-order {
            width: 100%;
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 18px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        /* --- SUCCESS EFFECT --- */
        #success-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
        }
        #success-overlay.show { opacity: 1; pointer-events: auto; }

        .success-icon {
            width: 100px; height: 100px;
            background: var(--primary-color);
            color: #fff;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem;
            margin-bottom: 20px;
            transform: scale(0);
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #success-overlay.show .success-icon { transform: scale(1); }

        .success-text {
            font-weight: 900; color: var(--primary-color);
            font-size: 1.8rem; text-align: center;
        }
    </style>
</head>
<body data-bs-spy="scroll" data-bs-target="#sidebar-nav" data-bs-offset="100">

<div class="restaurant-header">
    <img src="logobanme.png" alt="Logo" class="restaurant-logo" onerror="this.src='https://via.placeholder.com/100?text=BM'">
    <h1 class="restaurant-name">Ẩm thực Buôn Mê</h1>
</div>

<div class="order-container">
    <div id="sidebar-nav" class="sidebar">
        <div class="nav flex-column" id="category-list"></div>
    </div>
    <div class="menu-content" id="main-menu"></div>
</div>

<div class="footer-cart-icon" id="cartIcon" onclick="toggleCart()">
    <i class="bi bi-bag-heart-fill"></i>
    <div class="cart-badge" id="total-count-badge">0</div>
</div>

<div class="sheet-overlay" id="overlay" onclick="toggleCart()"></div>
<div class="order-sheet" id="orderSheet">
    <div class="sheet-handle"></div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="font-weight: 900; color: #3E2723; margin: 0;">Đơn hàng của bạn</h3>
        <span onclick="toggleCart()" style="color: #6D4C41; font-weight: 600; cursor: pointer;">Đóng</span>
    </div>
    <div id="cart-list"></div>
    <div class="sheet-footer" id="sheet-footer-ui" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span style="font-weight: 600; color: #8E8E93;">Tổng cộng:</span>
            <span id="total-price" style="font-size: 1.6rem; font-weight: 900; color: var(--primary-color);">0đ</span>
        </div>
        <button class="btn-confirm-order" onclick="submitOrder()">Gửi Đơn</button>
    </div>
</div>

<div id="success-overlay">
    <div class="success-icon"><i class="bi bi-check-lg"></i></div>
    <div class="success-text">Tuyệt vời!<br><span style="font-size: 1.1rem; font-weight: 600; color: #6D4C41;">Nhà hàng đã nhận được đơn của bạn.</span></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
        authDomain: "saigon-dalat.firebaseapp.com",
        databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
        projectId: "saigon-dalat",
        storageBucket: "saigon-dalat.firebasestorage.app",
        messagingSenderId: "339735183485",
        appId: "1:339735183485:web:bc23cd740104d272577114"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let masterMenu = {};
    let cart = {};
    let lastTotalCount = 0; // Biến theo dõi số lượng cũ để kích hoạt animation

    const foodLabels = { "4mon": "4 món đặc sản", "7mon": "Top trải nghiệm", "metTongHop": "Mẹt Tổng Hợp", "monCanh": "Món Canh", "monChinh": "Món Chính", "monRau": "Món Rau", "monthemmet": "Món Thêm" };
    const drinkLabels = { "coCon": "Đồ Có Cồn", "giaiKhat": "Giải Khát", "kem": "Kem", "nuocEp": "Nước Ép" };

    onValue(ref(db, '/'), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        masterMenu = { ...data.menu.food, ...data.menu.drink };
        renderFullMenu(data.menuGroups, data.menu);
    });

    function renderFullMenu(groups, menuData) {
        const sidebar = document.getElementById('category-list');
        const mainMenu = document.getElementById('main-menu');
        sidebar.innerHTML = '<div class="menu-group-label" style="font-size: 0.6rem; color: #C69C6D; letter-spacing: 2px; text-align: center; margin-bottom: 10px;">THỰC ĐƠN</div>';
        mainMenu.innerHTML = '';
        renderCategoryGroup(groups.food, menuData.food, foodLabels, sidebar, mainMenu);
        sidebar.innerHTML += '<div class="menu-group-label" style="margin-top: 15px; font-size: 0.6rem; color: #C69C6D; letter-spacing: 2px; text-align: center; margin-bottom: 10px;">THỨC UỐNG</div>';
        renderCategoryGroup(groups.drink, menuData.drink, drinkLabels, sidebar, mainMenu);
        
        setTimeout(() => {
            const scrollSpy = bootstrap.ScrollSpy.getInstance(document.body);
            if (scrollSpy) scrollSpy.refresh();
        }, 500);
    }

    function renderCategoryGroup(groups, details, labels, sidebarEl, contentEl) {
        Object.keys(labels).forEach(catId => {
            if (groups && groups[catId]) {
                let sectionContent = ''; let hasValid = false;
                Object.keys(groups[catId]).forEach(itemId => {
                    const info = details[itemId];
                    if (info && info.imageUrl && info.imageUrl.trim() !== "" && info.status !== "sold-out") {
                        hasValid = true;
                        sectionContent += `
                        <div class="food-item">
                            <img src="${info.imageUrl}" class="food-img" loading="lazy">
                            <div class="food-detail">
                                <div class="food-name">${info.name}</div>
                                <div class="d-flex justify-content-between align-items-end">
                                    <span class="food-price">${info.price.toLocaleString()}đ</span>
                                    <div class="quantity-control">
                                        <div class="btn-circle" onclick="updateCart('${itemId}', -1, ${info.price})">−</div>
                                        <span id="qty-${itemId}" style="font-weight:900; min-width:28px; text-align:center;">${cart[itemId]?.qty || 0}</span>
                                        <div class="btn-circle btn-add-fill" onclick="animateFly(event); updateCart('${itemId}', 1, ${info.price})">+</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }
                });
                if (hasValid) {
                    sidebarEl.innerHTML += `<a class="nav-link" href="#cat-${catId}">${labels[catId]}</a>`;
                    contentEl.innerHTML += `<div id="cat-${catId}"><div class="category-header">${labels[catId]}</div>${sectionContent}</div>`;
                }
            }
        });
    }

    window.updateCart = (id, delta, price) => {
        if (!cart[id]) cart[id] = { qty: 0, price: price, name: masterMenu[id]?.name || id };
        cart[id].qty += delta;
        if (cart[id].qty <= 0) delete cart[id];
        const qtyEl = document.getElementById(`qty-${id}`);
        if (qtyEl) qtyEl.innerText = cart[id]?.qty || 0;
        updateTotalUI();
    };

    function updateTotalUI() {
        let total = 0, count = 0;
        let listHtml = '';
        Object.keys(cart).forEach(id => { 
            const item = cart[id];
            total += (item.qty * item.price); count += item.qty;
            listHtml += `<div class="cart-item-row"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div><div class="cart-item-price">${item.price.toLocaleString()}đ</div></div><div class="quantity-control"><div class="btn-circle" onclick="updateCart('${id}', -1, ${item.price})">−</div><span style="font-weight:900; min-width:25px; text-align:center;">${item.qty}</span><div class="btn-circle btn-add-fill" onclick="updateCart('${id}', 1, ${item.price})">+</div></div></div>`;
        });
        
        const icon = document.getElementById('cartIcon');
        
        // Kích hoạt hiệu ứng nhấp nhô nếu số lượng tăng lên
        if (count > lastTotalCount) {
            icon.classList.remove('bump');
            void icon.offsetWidth; // Trigger reflow để reset animation
            icon.classList.add('bump');
            // Gỡ bỏ class sau khi animation hoàn tất để sẵn sàng cho lần sau
            setTimeout(() => icon.classList.remove('bump'), 500);
        }
        lastTotalCount = count;

        if (count > 0) { 
            icon.classList.add('visible'); 
            document.getElementById('total-count-badge').innerText = count; 
            document.getElementById('sheet-footer-ui').style.display = 'block'; 
        }
        else { 
            icon.classList.remove('visible'); 
            document.getElementById('sheet-footer-ui').style.display = 'none'; 
            toggleCart(false); 
        }
        
        document.getElementById('total-price').innerText = total.toLocaleString() + 'đ';
        document.getElementById('cart-list').innerHTML = listHtml || '<p style="text-align:center; opacity:0.4; margin-top:40px;">Giỏ hàng trống</p>';
    }

    window.animateFly = (e) => {
        const dot = document.createElement('div');
        dot.className = 'fly-dot';
        dot.style.left = e.clientX + 'px'; dot.style.top = e.clientY + 'px';
        document.body.appendChild(dot);
        
        requestAnimationFrame(() => {
            const rect = document.getElementById('cartIcon').getBoundingClientRect();
            const targetX = rect.width > 0 ? (rect.left + 35) : (window.innerWidth - 60);
            const targetY = rect.height > 0 ? (rect.top + 35) : (window.innerHeight - 60);
            
            dot.style.left = targetX + 'px';
            dot.style.top = targetY + 'px';
            dot.style.transform = 'scale(0.1)'; 
            dot.style.opacity = '0.5';
        });
        
        setTimeout(() => dot.remove(), 1500);
    };

    window.toggleCart = (force) => {
        const sheet = document.getElementById('orderSheet');
        const overlay = document.getElementById('overlay');
        if (force === false) { sheet.classList.remove('open'); overlay.style.display = 'none'; return; }
        sheet.classList.toggle('open');
        overlay.style.display = sheet.classList.contains('open') ? 'block' : 'none';
    };

    window.submitOrder = () => {
        toggleCart(false);
        const success = document.getElementById('success-overlay');
        success.classList.add('show');
        const duration = 3 * 1000;
        const end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#C69C6D', '#3E2723'] });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#C69C6D', '#3E2723'] });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
        setTimeout(() => {
            success.classList.remove('show');
            cart = {};
            updateTotalUI();
            location.reload();
        }, 4000);
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
