<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ẩm thực Buôn Mê - Premium Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #3E2723;
            --gold-accent: #C69C6D;
            --bg-creme: #FAF9F6;
            --ios-blur: rgba(255, 255, 255, 0.85);
            --header-height: 80px;
            --sidebar-width: 110px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* KHÓA CUỘN NGANG TUYỆT ĐỐI */
        html, body {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden !important;
            position: fixed;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-creme);
            color: #2C1B18;
        }

        /* --- HEADER --- */
        .restaurant-header {
            height: var(--header-height);
            background: var(--ios-blur);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            display: flex;
            align-items: center;
            padding: 0 15px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1100;
            border-bottom: 1px solid rgba(62, 39, 35, 0.08);
        }

        .restaurant-logo {
            height: 40px; width: 40px;
            object-fit: contain; border-radius: 10px; margin-right: 12px;
        }

        .restaurant-name {
            font-weight: 900; font-size: 1.2rem;
            color: var(--primary-color); margin: 0;
            letter-spacing: -0.5px; text-transform: uppercase;
        }

        /* --- LAYOUT --- */
        .order-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            padding-top: var(--header-height);
            padding-bottom: var(--safe-area-bottom);
        }

        .sidebar {
            width: var(--sidebar-width);
            flex-shrink: 0;
            background: #F2EFE9;
            overflow-y: auto;
            scrollbar-width: none;
            border-right: 1px solid rgba(62, 39, 35, 0.05);
            padding: 10px 5px;
        }
        .sidebar::-webkit-scrollbar { display: none; }

        /* Tiêu đề nhóm trong sidebar */
        .sidebar-group-label {
            font-size: 0.65rem;
            font-weight: 800;
            color: var(--gold-accent);
            text-align: center;
            letter-spacing: 1px;
            margin: 15px 0 8px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .nav-link {
            padding: 12px 8px;
            margin-bottom: 8px;
            color: #8D736B;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 14px;
            transition: all 0.3s ease;
            line-height: 1.2;
            border: 1px solid transparent;
        }

        /* Highlight danh mục đang xem */
        .nav-link.active {
            background: #FFFFFF !important;
            color: var(--primary-color) !important;
            font-weight: 900 !important;
            box-shadow: 0 8px 15px rgba(62, 39, 35, 0.1);
            transform: scale(1.05);
            border: 1px solid rgba(198, 156, 109, 0.2);
        }

        /* --- CONTENT --- */
        .menu-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            padding: 0 15px;
            -webkit-overflow-scrolling: touch;
        }

        .category-header {
            position: relative;
            font-weight: 900;
            font-size: 1.6rem;
            color: var(--primary-color);
            letter-spacing: -1px;
            margin: 25px 0 15px;
        }

        .food-item {
            display: flex;
            padding: 12px;
            background: #fff;
            border-radius: 20px;
            margin-bottom: 15px;
            box-shadow: 0 6px 15px rgba(62, 39, 35, 0.04);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .food-item:active { transform: scale(0.96); background: #FDFCFB; }

        .food-img { width: 85px; height: 85px; object-fit: cover; border-radius: 15px; flex-shrink: 0; }
        .food-detail { flex: 1; padding-left: 12px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .food-name { font-weight: 700; font-size: 1rem; color: #2D1B18; margin-bottom: 4px; }
        .food-price { color: var(--primary-color); font-weight: 800; font-size: 1.1rem; }

        .item-badge {
            position: absolute; top: 8px; right: 8px;
            background: var(--gold-accent); color: white;
            font-size: 0.7rem; padding: 2px 8px; border-radius: 10px;
            font-weight: 800; display: none;
        }

        /* --- FLY ANIMATION --- */
        .fly-dot {
            position: fixed; width: 25px; height: 25px;
            background: var(--gold-accent); border-radius: 50%;
            z-index: 9999; pointer-events: none;
            box-shadow: 0 0 15px var(--gold-accent);
            transition: all 0.8s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        /* --- CART ICON & BADGE --- */
        .footer-cart-icon {
            position: fixed; bottom: calc(25px + var(--safe-area-bottom));
            right: 20px; width: 60px; height: 60px;
            background: var(--primary-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 2000;
            opacity: 0; transform: translateY(100px);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .footer-cart-icon.visible { opacity: 1; transform: translateY(0); }

        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .footer-cart-icon.bump { animation: bounce 0.4s ease-out; }

        .cart-badge {
            position: absolute; top: -2px; right: -2px;
            background: var(--gold-accent); color: white;
            font-weight: 800; font-size: 0.75rem;
            min-width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--primary-color);
        }

        /* --- ORDER SHEET --- */
        .order-sheet {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background: #fff; border-radius: 30px 30px 0 0;
            z-index: 2100; padding: 20px;
            padding-bottom: calc(20px + var(--safe-area-bottom));
            max-height: 80vh; overflow-y: auto;
            transition: bottom 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .order-sheet.open { bottom: 0; }
        .sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 2050; display: none; }

        .quantity-control { display: flex; align-items: center; background: #F5F3F0; border-radius: 20px; padding: 3px; gap: 8px; }
        .btn-circle { width: 30px; height: 30px; border-radius: 50%; border: none; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600; }
        .btn-confirm-order { width: 100%; background: var(--primary-color); color: #fff; border: none; padding: 16px; border-radius: 18px; font-weight: 800; margin-top: 15px; }

        #success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.4s; }
        #success-overlay.show { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body data-bs-spy="scroll" data-bs-target="#sidebar-nav" data-bs-offset="100">

<div class="restaurant-header">
    <img src="logobanme.png" alt="Logo" class="restaurant-logo" onerror="this.src='https://via.placeholder.com/100?text=BM'">
    <h1 class="restaurant-name">Ẩm thực Buôn Mê</h1>
</div>

<div class="order-container">
    <div id="sidebar-nav" class="sidebar">
        <div class="nav flex-column" id="category-list"></div>
    </div>
    <div class="menu-content" id="main-menu"></div>
</div>

<div class="footer-cart-icon" id="cartIcon" onclick="toggleCart()">
    <i class="bi bi-bag-heart-fill" style="color:white; font-size:1.5rem;"></i>
    <div class="cart-badge" id="total-count-badge">0</div>
</div>

<div class="sheet-overlay" id="overlay" onclick="toggleCart()"></div>
<div class="order-sheet" id="orderSheet">
    <div style="width:40px; height:4px; background:#DDD; border-radius:10px; margin:0 auto 15px;"></div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 style="font-weight: 800; color: #3E2723; margin: 0;">Giỏ hàng</h4>
        <span onclick="toggleCart()" style="color: #C69C6D; font-weight: 700;">Đóng</span>
    </div>
    <div id="cart-list"></div>
    <div id="sheet-footer-ui" style="display:none; margin-top:20px; border-top:1px solid #EEE;">
        <div class="d-flex justify-content-between align-items-center mt-3">
            <span style="font-weight: 600; color: #888;">Tổng cộng:</span>
            <span id="total-price" style="font-size: 1.4rem; font-weight: 900; color: var(--primary-color);">0đ</span>
        </div>
        <button class="btn-confirm-order" onclick="submitOrder()">ĐẶT MÓN NGAY</button>
    </div>
</div>

<div id="success-overlay">
    <i class="bi bi-check-circle-fill" style="font-size: 5rem; color: var(--primary-color);"></i>
    <h2 style="font-weight: 900; margin-top: 20px;">Gửi đơn thành công!</h2>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
        authDomain: "saigon-dalat.firebaseapp.com",
        databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
        projectId: "saigon-dalat",
        storageBucket: "saigon-dalat.firebasestorage.app",
        messagingSenderId: "339735183485",
        appId: "1:339735183485:web:bc23cd740104d272577114"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let masterMenu = {};
    let cart = {};
    let lastTotalCount = 0;

    const foodLabels = { "4mon": "4 món đặc sản", "7mon": "Top trải nghiệm", "metTongHop": "Mẹt Tổng Hợp", "monCanh": "Món Canh", "monChinh": "Món Chính", "monRau": "Món Rau", "monthemmet": "Món Thêm" };
    const drinkLabels = { "coCon": "Đồ Có Cồn", "giaiKhat": "Giải Khát", "kem": "Kem", "nuocEp": "Nước Ép" };

    onValue(ref(db, '/'), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        masterMenu = { ...data.menu.food, ...data.menu.drink };
        renderFullMenu(data.menuGroups, data.menu);
    });

    function renderFullMenu(groups, menuData) {
        const sidebar = document.getElementById('category-list');
        const mainMenu = document.getElementById('main-menu');
        sidebar.innerHTML = '';
        mainMenu.innerHTML = '';
        
        // Render NHÓM THỰC ĐƠN
        sidebar.innerHTML += '<div class="sidebar-group-label">Thực đơn</div>';
        renderCategoryGroup(groups.food, menuData.food, foodLabels, sidebar, mainMenu);
        
        // Render NHÓM THỨC UỐNG
        sidebar.innerHTML += '<div class="sidebar-group-label">Thức uống</div>';
        renderCategoryGroup(groups.drink, menuData.drink, drinkLabels, sidebar, mainMenu);
        
        // Làm mới ScrollSpy sau khi render
        setTimeout(() => {
            const scrollSpy = bootstrap.ScrollSpy.getInstance(document.body);
            if (scrollSpy) scrollSpy.refresh();
        }, 300);
    }

    function renderCategoryGroup(groups, details, labels, sidebarEl, contentEl) {
        Object.keys(labels).forEach(catId => {
            if (groups && groups[catId]) {
                let sectionContent = ''; let hasValid = false;
                Object.keys(groups[catId]).forEach(itemId => {
                    const info = details[itemId];
                    if (info && info.imageUrl && info.imageUrl.trim() !== "" && info.status !== "sold-out") {
                        hasValid = true;
                        sectionContent += `
                        <div class="food-item" onclick="handleItemClick(event, '${itemId}', ${info.price})">
                            <div class="item-badge" id="badge-${itemId}">0</div>
                            <img src="${info.imageUrl}" class="food-img" loading="lazy">
                            <div class="food-detail">
                                <div class="food-name">${info.name}</div>
                                <div class="food-price">${info.price.toLocaleString()}đ</div>
                            </div>
                        </div>`;
                    }
                });
                if (hasValid) {
                    sidebarEl.innerHTML += `<a class="nav-link" href="#cat-${catId}">${labels[catId]}</a>`;
                    contentEl.innerHTML += `<div id="cat-${catId}"><div class="category-header">${labels[catId]}</div>${sectionContent}</div>`;
                }
            }
        });
    }

    window.handleItemClick = (e, id, price) => {
        animateFly(e);
        updateCart(id, 1, price);
    };

    window.updateCart = (id, delta, price) => {
        if (!cart[id]) cart[id] = { qty: 0, price: price, name: masterMenu[id]?.name || id };
        cart[id].qty += delta;
        if (cart[id].qty <= 0) delete cart[id];
        
        const b = document.getElementById(`badge-${id}`);
        if(b) {
            b.innerText = cart[id]?.qty || 0;
            b.style.display = cart[id]?.qty > 0 ? 'block' : 'none';
        }
        updateTotalUI();
    };

    function updateTotalUI() {
        let total = 0, count = 0;
        let listHtml = '';
        Object.keys(cart).forEach(id => { 
            const item = cart[id];
            total += (item.qty * item.price); count += item.qty;
            listHtml += `
            <div class="cart-item-row">
                <div style="flex:1">
                    <div style="font-weight:700; color:#3E2723">${item.name}</div>
                    <div style="color:#C69C6D; font-size:0.9rem">${(item.qty * item.price).toLocaleString()}đ</div>
                </div>
                <div class="quantity-control">
                    <div class="btn-circle" onclick="updateCart('${id}', -1, ${item.price})">−</div>
                    <span style="font-weight:800; min-width:20px; text-align:center;">${item.qty}</span>
                    <div class="btn-circle" style="background:var(--primary-color); color:white" onclick="updateCart('${id}', 1, ${item.price})">+</div>
                </div>
            </div>`;
        });
        
        const icon = document.getElementById('cartIcon');
        if (count > lastTotalCount) {
            icon.classList.remove('bump');
            void icon.offsetWidth;
            icon.classList.add('bump');
        }
        lastTotalCount = count;

        if (count > 0) { 
            icon.classList.add('visible'); 
            document.getElementById('total-count-badge').innerText = count; 
            document.getElementById('sheet-footer-ui').style.display = 'block'; 
        } else { 
            icon.classList.remove('visible'); 
            document.getElementById('sheet-footer-ui').style.display = 'none'; 
            toggleCart(false); 
        }
        document.getElementById('total-price').innerText = total.toLocaleString() + 'đ';
        document.getElementById('cart-list').innerHTML = listHtml || '<p style="text-align:center; opacity:0.4; margin-top:20px;">Giỏ hàng đang trống</p>';
    }

    window.animateFly = (e) => {
        const dot = document.createElement('div');
        dot.className = 'fly-dot';
        dot.style.left = e.clientX + 'px'; dot.style.top = e.clientY + 'px';
        document.body.appendChild(dot);
        setTimeout(() => {
            const rect = document.getElementById('cartIcon').getBoundingClientRect();
            dot.style.left = (rect.left + 20) + 'px';
            dot.style.top = (rect.top + 20) + 'px';
            dot.style.transform = 'scale(0.2)'; dot.style.opacity = '0';
        }, 10);
        setTimeout(() => dot.remove(), 800);
    };

    window.toggleCart = (force) => {
        const sheet = document.getElementById('orderSheet');
        const overlay = document.getElementById('overlay');
        if (force === false) { sheet.classList.remove('open'); overlay.style.display = 'none'; return; }
        sheet.classList.toggle('open');
        overlay.style.display = sheet.classList.contains('open') ? 'block' : 'none';
    };

    window.submitOrder = () => {
        toggleCart(false);
        const success = document.getElementById('success-overlay');
        success.classList.add('show');
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#C69C6D', '#3E2723'] });
        setTimeout(() => location.reload(), 3000);
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
