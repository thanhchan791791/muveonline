<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quản lý Câu hỏi iOS</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-text: #000000;
            --ios-secondary-text: #8E8E93;
            --ios-border: rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.08);
            --easing: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--ios-bg);
            color: var(--ios-text);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 450px; animation: fadeIn 0.5s var(--easing); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 24px; font-weight: 700; margin: 20px 0 15px 10px; display: flex; align-items: center; gap: 8px; }

        .card {
            background: var(--ios-card);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 25px;
        }

        .form-group { margin-bottom: 20px; }
        label { font-size: 12px; font-weight: 600; color: var(--ios-secondary-text); text-transform: uppercase; margin-bottom: 8px; display: block; padding-left: 4px; }

        /* Segmented Control iOS Style */
        .segmented-control {
            display: flex;
            background: #E3E3E8;
            padding: 2px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .segmented-control input { display: none; }
        .segmented-control label {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            margin: 0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--ios-text);
            text-transform: none;
            transition: all 0.2s;
        }
        .segmented-control input:checked + label {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        textarea, input[type="text"] {
            width: 100%; border: none; background: #F2F2F7; border-radius: 12px; padding: 12px 15px;
            font-size: 16px; color: var(--ios-text); outline: none; transition: 0.2s;
        }

        /* Search Bar Style */
        .search-container {
            position: relative;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        .search-container i {
            position: absolute;
            left: 22px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ios-secondary-text);
        }
        #searchInput {
            padding-left: 40px;
            background: #E3E3E8;
            border-radius: 10px;
            height: 36px;
        }

        /* Đáp án trắc nghiệm */
        #multipleChoiceArea { display: block; }
        .answer-item { display: flex; align-items: center; background: #F2F2F7; border-radius: 12px; padding: 4px 12px; margin-bottom: 8px; }
        
        input[type="radio"] {
            appearance: none; width: 22px; height: 22px; border: 2px solid #C7C7CC; border-radius: 50%;
            position: relative; cursor: pointer; transition: 0.2s; flex-shrink: 0;
        }
        input[type="radio"]:checked { border-color: var(--ios-blue); background: var(--ios-blue); }
        input[type="radio"]:checked::after {
            content: ''; position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        /* Đáp án tự luận */
        #writtenArea { display: none; }

        button {
            width: 100%; padding: 16px; border: none; border-radius: 100px; font-weight: 600; font-size: 16px;
            cursor: pointer; transition: 0.3s var(--easing); display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        #btnSave { background: var(--ios-blue); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        button:active { transform: scale(0.96); opacity: 0.8; }

        /* List Style */
        .q-list { display: flex; flex-direction: column; gap: 10px; }
        .q-card {
            background: var(--ios-card); border-radius: 16px; overflow: hidden;
            transition: all 0.3s var(--easing); border: 1px solid transparent;
        }
        .q-header { padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .q-title { font-weight: 600; font-size: 16px; flex: 1; padding-right: 10px; }
        .type-badge { font-size: 10px; background: #E5E5EA; padding: 2px 8px; border-radius: 6px; margin-right: 8px; color: #666; }
        
        .q-details { 
            max-height: 0; overflow: hidden; transition: max-height 0.4s var(--easing);
            background: #FAFAFA; padding: 0 16px;
        }
        .q-card.open .q-details { max-height: 800px; padding: 16px; border-top: 1px solid var(--ios-bg); }
        
        .ans-row { 
            padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; font-size: 14px;
            background: white; border: 1px solid #EEE; display: flex; align-items: center; gap: 8px;
        }
        .ans-row.correct { border-color: var(--ios-green); background: #F2FBF4; color: #1A7F37; }
        .written-content { background: white; padding: 12px; border-radius: 12px; border: 1px solid #EEE; font-size: 14px; white-space: pre-wrap; }

        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-edit { background: #E5E5EA; color: var(--ios-text); padding: 10px; flex: 1; border-radius: 10px; }
        .btn-delete { background: #FFE5E5; color: var(--ios-red); padding: 10px; flex: 1; border-radius: 10px; }

        #status { text-align: center; margin-top: 15px; font-size: 14px; font-weight: 500; }

        @media (prefers-color-scheme: dark) {
            :root { --ios-bg: #000000; --ios-card: #1C1C1E; --ios-text: #FFFFFF; }
            textarea, input[type="text"], .answer-item, .q-details, .segmented-control { background: #2C2C2E; }
            #searchInput { background: #1C1C1E; border: 1px solid #333; }
            .ans-row, .written-content { background: #1C1C1E; border-color: #333; }
            .segmented-control label { color: #BBB; }
            .segmented-control input:checked + label { background: #444; color: white; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2><i data-lucide="plus-circle" size="24"></i> Thêm nội dung</h2>
    
    <div class="card">
        <label>Thể loại câu hỏi</label>
        <div class="segmented-control">
            <input type="radio" name="qType" id="typeQuiz" value="quiz" checked>
            <label for="typeQuiz">Trắc nghiệm</label>
            <input type="radio" name="qType" id="typeWritten" value="written">
            <label for="typeWritten">Tự luận / Liệt kê</label>
        </div>

        <div class="form-group">
            <label>Nội dung câu hỏi</label>
            <textarea id="questionText" rows="3" placeholder="Ví dụ: Kể tên 4 dịch vụ của CherryPet..."></textarea>
        </div>

        <div id="multipleChoiceArea">
            <label>Đáp án (Chọn nút tròn cho câu đúng)</label>
            <div class="answer-item"><input type="radio" name="correctAnswer" value="0" checked><input type="text" class="answer-input" placeholder="Đáp án A"></div>
            <div class="answer-item"><input type="radio" name="correctAnswer" value="1"><input type="text" class="answer-input" placeholder="Đáp án B"></div>
            <div class="answer-item"><input type="radio" name="correctAnswer" value="2"><input type="text" class="answer-input" placeholder="Đáp án C"></div>
            <div class="answer-item"><input type="radio" name="correctAnswer" value="3"><input type="text" class="answer-input" placeholder="Đáp án D"></div>
        </div>

        <div id="writtenArea">
            <label>Nội dung câu trả lời liệt kê</label>
            <textarea id="writtenAnswer" rows="4" placeholder="Nhập các ý trả lời tại đây..."></textarea>
        </div>

        <button id="btnSave" style="margin-top:20px"><i data-lucide="cloud-upload"></i> Lưu vào hệ thống</button>
        <div id="status"></div>
    </div>

    <h2><i data-lucide="list" size="24"></i> Danh sách đã lưu</h2>
    
    <div class="search-container">
        <i data-lucide="search" size="18"></i>
        <input type="text" id="searchInput" placeholder="Tìm kiếm câu hỏi...">
    </div>

    <div id="questionList" class="q-list"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAMycdJcRR1Kl53wrJQbQ9dw-xSfpOym_4",
        authDomain: "lichnghi2.firebaseapp.com",
        databaseURL: "https://lichnghi2-default-rtdb.firebaseio.com",
        projectId: "lichnghi2",
        storageBucket: "lichnghi2.firebasestorage.app",
        messagingSenderId: "534827443513",
        appId: "1:534827443513:web:003b8b9d8132f9e6cc74e8",
        measurementId: "G-SHSCW5H652"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let editingId = null;
    let allQuestions = {}; // Biến lưu trữ toàn bộ data để lọc

    // Toggle UI dựa trên Type
    const typeRadios = document.querySelectorAll('input[name="qType"]');
    typeRadios.forEach(r => r.addEventListener('change', (e) => {
        const isQuiz = e.target.value === 'quiz';
        document.getElementById('multipleChoiceArea').style.display = isQuiz ? 'block' : 'none';
        document.getElementById('writtenArea').style.display = isQuiz ? 'none' : 'block';
    }));

    // Hàm hiển thị danh sách (được tách ra để dùng cho cả Load và Search)
    const renderList = (data) => {
        const listDiv = document.getElementById('questionList');
        listDiv.innerHTML = '';
        
        if (!data || Object.keys(data).length === 0) {
            return listDiv.innerHTML = '<p style="text-align:center; color:#8E8E93">Trống hoặc không tìm thấy</p>';
        }

        Object.keys(data).reverse().forEach(id => {
            const q = data[id];
            const isQuiz = q.type === 'quiz' || !q.type;
            
            const qCard = document.createElement('div');
            qCard.className = 'q-card';
            qCard.innerHTML = `
                <div class="q-header" onclick="this.parentElement.classList.toggle('open')">
                    <span class="q-title"><span class="type-badge">${isQuiz ? 'Trắc nghiệm' : 'Tự luận'}</span>${q.question}</span>
                    <i data-lucide="chevron-down" size="18"></i>
                </div>
                <div class="q-details">
                    ${isQuiz ? 
                        q.answers.map(a => `<div class="ans-row ${a.isCorrect ? 'correct' : ''}"><i data-lucide="${a.isCorrect ? 'check-circle' : 'circle'}" size="14"></i>${a.text || ''}</div>`).join('') 
                        : `<div class="written-content">${q.writtenAnswer}</div>`
                    }
                    <div class="actions">
                        <button class="btn-edit" onclick="editQuestion('${id}')"><i data-lucide="edit-3" size="16"></i> Sửa</button>
                        <button class="btn-delete" onclick="deleteQuestion('${id}')"><i data-lucide="trash-2" size="16"></i> Xóa</button>
                    </div>
                </div>
            `;
            listDiv.appendChild(qCard);
        });
        lucide.createIcons();
    };

    // Load Data ban đầu
    onValue(ref(db, 'questions'), (snapshot) => {
        allQuestions = snapshot.val() || {};
        renderList(allQuestions);
    });

    // Sự kiện Tìm kiếm (Lọc tới đâu hiện tới đó)
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase().trim();
        if (!keyword) {
            renderList(allQuestions);
            return;
        }

        const filtered = {};
        Object.keys(allQuestions).forEach(id => {
            const q = allQuestions[id];
            // Tìm trong câu hỏi hoặc nội dung trả lời tự luận
            const inQuestion = q.question.toLowerCase().includes(keyword);
            const inWritten = q.writtenAnswer && q.writtenAnswer.toLowerCase().includes(keyword);
            
            if (inQuestion || inWritten) {
                filtered[id] = q;
            }
        });
        renderList(filtered);
    });

    // Save/Update
    document.getElementById('btnSave').addEventListener('click', async () => {
        const qType = document.querySelector('input[name="qType"]:checked').value;
        const questionText = document.getElementById('questionText').value;
        const status = document.getElementById('status');
        
        if (!questionText.trim()) return alert("Nhập câu hỏi");

        let payload = { 
            type: qType, 
            question: questionText, 
            updatedAt: Date.now() 
        };

        if (qType === 'quiz') {
            const answerInputs = document.querySelectorAll('.answer-input');
            const correctIndex = document.querySelector('input[name="correctAnswer"]:checked').value;
            payload.answers = Array.from(answerInputs).map((input, index) => ({
                text: input.value,
                isCorrect: index == correctIndex
            }));
        } else {
            payload.writtenAnswer = document.getElementById('writtenAnswer').value;
        }

        try {
            if (editingId) {
                await update(ref(db, `questions/${editingId}`), payload);
                editingId = null;
                document.getElementById('btnSave').innerHTML = '<i data-lucide="cloud-upload"></i> Lưu vào hệ thống';
            } else {
                payload.createdAt = Date.now();
                await push(ref(db, 'questions'), payload);
            }
            
            // Reset Form
            document.getElementById('questionText').value = '';
            document.getElementById('writtenAnswer').value = '';
            document.querySelectorAll('.answer-input').forEach(i => i.value = '');
            status.innerText = "Đã lưu!";
            setTimeout(() => status.innerText = "", 2000);
        } catch (e) { alert(e.message); }
    });

    window.deleteQuestion = (id) => confirm("Xóa câu hỏi này?") && remove(ref(db, `questions/${id}`));

    window.editQuestion = (id) => {
        onValue(ref(db, `questions/${id}`), (snapshot) => {
            const q = snapshot.val();
            if(!q) return;
            
            const isQuiz = q.type === 'quiz' || !q.type;
            document.getElementById(isQuiz ? 'typeQuiz' : 'typeWritten').checked = true;
            document.getElementById('multipleChoiceArea').style.display = isQuiz ? 'block' : 'none';
            document.getElementById('writtenArea').style.display = isQuiz ? 'none' : 'block';
            
            document.getElementById('questionText').value = q.question;
            if (isQuiz) {
                const inputs = document.querySelectorAll('.answer-input');
                const radios = document.querySelectorAll('input[name="correctAnswer"]');
                q.answers.forEach((a, i) => {
                    inputs[i].value = a.text;
                    if(a.isCorrect) radios[i].checked = true;
                });
            } else {
                document.getElementById('writtenAnswer').value = q.writtenAnswer || "";
            }
            
            editingId = id;
            document.getElementById('btnSave').innerHTML = '<i data-lucide="save"></i> Cập nhật thay đổi';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, { onlyOnce: true });
    };

    lucide.createIcons();
</script>

</body>
</html>
