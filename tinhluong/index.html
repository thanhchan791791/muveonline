<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Th·ªëng K√™ Ch·∫•m C√¥ng & T√≠nh L∆∞∆°ng</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
            authDomain: "saigon-dalat.firebaseapp.com",
            databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
            projectId: "saigon-dalat",
            storageBucket: "saigon-dalat.firebasestorage.app",
            messagingSenderId: "339735183485",
            appId: "1:339735183485:web:bc23cd740104d272577114",
            measurementId: "G-FDLZXR2X8P"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.cloudBonusData = [];
        window.cloudSalaryData = [];
        window.cloudPenaltySummary = {}; 

        onValue(query(ref(db, 'bonus_records'), limitToLast(1)), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const lastKey = Object.keys(data)[0];
                window.cloudBonusData = data[lastKey].records || [];
                syncDataAfterUpload();
            }
        });

        onValue(query(ref(db, 'salary_config'), limitToLast(1)), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const lastKey = Object.keys(data)[0];
                window.cloudSalaryData = data[lastKey].records || [];
                syncDataAfterUpload();
            }
        });

        onValue(query(ref(db, 'penalty_records'), limitToLast(10)), (snapshot) => {
            window.cloudPenaltySummary = {}; 
            if (snapshot.exists()) {
                const allBatches = snapshot.val();
                Object.values(allBatches).forEach(batch => {
                    if (batch.records) {
                        batch.records.forEach(rec => {
                            if (!window.cloudPenaltySummary[rec.name]) {
                                window.cloudPenaltySummary[rec.name] = { total: 0, details: [] };
                            }
                            window.cloudPenaltySummary[rec.name].total += rec.totalPenalty || 0;
                            if (rec.details) window.cloudPenaltySummary[rec.name].details.push(...rec.details);
                        });
                    }
                });
            }
            syncDataAfterUpload();
        });

        window.saveSalaryToFirebase = function() {
            if (allEmployees.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            const data = allEmployees
                .filter(emp => emp.hourlyRate > 0)
                .map(emp => ({ id: emp.id, name: emp.name, hourlyRate: emp.hourlyRate }));
            set(ref(db, 'salary_config/Salary_' + Date.now()), { records: data, createdAt: new Date().toLocaleString() })
            .then(() => alert("‚úÖ ƒê√£ l∆∞u!"));
        };

        window.saveBonusToFirebase = function() {
            if (allEmployees.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            const data = allEmployees
                .filter(emp => (emp.bonusAmount > 0 || emp.bonusNote !== ""))
                .map(emp => ({ id: emp.id, name: emp.name, bonusAmount: emp.bonusAmount, bonusNote: emp.bonusNote }));
            set(ref(db, 'bonus_records/Bonus_' + Date.now()), { records: data, createdAt: new Date().toLocaleString() })
            .then(() => alert("‚úÖ ƒê√£ l∆∞u!"));
        };

        window.savePenaltyToFirebase = function() {
            if (allEmployees.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            const data = allEmployees
                .filter(emp => (emp.stats.totalPenalty > 0))
                .map(emp => ({ id: emp.id, name: emp.name, totalPenalty: emp.stats.totalPenalty, details: emp.lateDetails }));
            set(ref(db, 'penalty_records/Penalty_' + Date.now()), { records: data, createdAt: new Date().toLocaleString() })
            .then(() => alert("‚úÖ ƒê√£ l∆∞u!"));
        };

        window.openPenaltyModal = function() {
            const tbody = document.getElementById('penalty-body');
            tbody.innerHTML = '';
            allEmployees.forEach(emp => {
                const cloudData = window.cloudPenaltySummary[emp.name] || { total: 0, details: [] };
                const total = emp.stats.totalPenalty + cloudData.total;
                const allDetails = [...new Set([...cloudData.details, ...emp.lateDetails])];
                if (total > 0) {
                    tbody.innerHTML += `<tr><td style="font-weight:600">${emp.name}</td><td style="font-size:11px; color:#8E8E93;">${allDetails.join('<br>')}</td><td style="color:#FF3B30; font-weight:700; text-align:right;">${total.toLocaleString()}ƒë</td></tr>`;
                }
            });
            document.getElementById('penalty-overlay').style.display = 'flex';
        };
    </script>

    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-orange: #FF9500;
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.85);
            --ios-text: #1C1C1E;
            --ios-secondary-text: #8E8E93;
            --ios-border: rgba(60, 60, 67, 0.12);
            --radius-xl: 24px;
            --radius-lg: 18px;
            --radius-md: 12px;
            --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.04);
            --bezier-ios: cubic-bezier(0.32, 0.72, 0, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
        }

        body { 
            background-color: var(--ios-bg); 
            color: var(--ios-text); 
            margin: 0; 
            padding: 20px 16px env(safe-area-inset-bottom);
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        h2 {
            font-size: 34px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        #date-range { 
            font-size: 15px; 
            font-weight: 500;
            color: var(--ios-secondary-text); 
            margin-bottom: 24px; 
            padding-left: 4px;
        }

        /* Upload Section */
        .upload-section { 
            background: var(--ios-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); 
            padding: 24px; 
            text-align: center; 
            border: 1px solid var(--ios-border);
            box-shadow: var(--shadow-soft);
            margin-bottom: 24px;
            transition: transform 0.2s var(--bezier-ios);
        }
        
        input[type="file"] {
            font-size: 15px;
            color: var(--ios-secondary-text);
        }

        /* Action Buttons */
        .action-bar { 
            display: none; 
            flex-direction: column; 
            gap: 12px; 
            margin-bottom: 24px; 
            animation: slideUp 0.5s var(--bezier-ios);
        }

        .btn-action { 
            width: 100%; 
            padding: 16px; 
            border: none; 
            border-radius: var(--radius-md); 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            color: white; 
            transition: all 0.2s var(--bezier-ios);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-action:active { transform: scale(0.96); opacity: 0.9; }
        .btn-salary { background: linear-gradient(135deg, #34C759, #28a745); }
        .btn-bonus { background: linear-gradient(135deg, #FF9500, #ff8000); }
        .btn-penalty { background: linear-gradient(135deg, #FF3B30, #d93025); }

        /* Table/List View */
        #summary-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            display: none; 
        }

        #summary-table tr { 
            background: var(--ios-card); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--ios-border);
            border-radius: var(--radius-lg); 
            display: flex;
            flex-direction: column;
            padding: 16px; 
            margin-bottom: 12px; 
            box-shadow: var(--shadow-soft);
            animation: fadeIn 0.4s var(--bezier-ios) forwards;
        }

        #summary-table td { 
            display: flex; 
            justify-content: space-between; 
            padding: 4px 0; 
            font-size: 16px;
        }

        #summary-table td:first-child { color: var(--ios-secondary-text); font-size: 13px; font-weight: 600; text-transform: uppercase; }
        #summary-table td:last-child { font-weight: 700; color: var(--ios-blue); font-size: 17px; }

        .emp-name-btn { 
            color: var(--ios-text) !important; 
            font-weight: 700 !important; 
            font-size: 20px !important;
            cursor: pointer; 
            text-decoration: none !important;
            margin: 4px 0 8px 0;
        }

        /* Modal / Overlays */
        [id$="-overlay"] { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.3); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            z-index: 1000; 
            justify-content: center; 
            align-items: flex-end; 
        }

        #detail-overlay { align-items: center; }

        .modal-content { 
            background: white; 
            width: 100%; 
            max-width: 500px; 
            max-height: 90vh; 
            border-radius: var(--radius-xl) var(--radius-xl) 0 0; 
            padding: 24px; 
            position: relative; 
            overflow-y: auto; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            animation: sheetUp 0.4s var(--bezier-ios);
        }

        #detail-overlay .modal-content {
            width: 92%;
            border-radius: var(--radius-xl);
            animation: modalScale 0.3s var(--bezier-ios);
        }

        .close-btn { 
            position: absolute; 
            top: 16px; right: 20px; 
            font-size: 28px; 
            font-weight: 600;
            cursor: pointer; 
            color: #C7C7CC; 
        }

        /* Attendance Grid */
        .attendance-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            margin-bottom: 24px; 
        }

        .date-card { 
            background: #F2F2F7; 
            border-radius: var(--radius-md); 
            padding: 8px 4px; 
            text-align: center; 
            border: 1px solid rgba(0,0,0,0.03); 
        }

        .date-label { font-size: 10px; font-weight: 700; color: var(--ios-secondary-text); display: block; margin-bottom: 2px; }
        .time-label { font-size: 10px; color: var(--ios-blue); font-weight: 600; line-height: 1.2; display: block; }

        /* Financial Box */
        .financial-summary { 
            background: #F9F9FB; 
            padding: 20px; 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--ios-border); 
        }

        .financial-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; font-weight: 500; }
        .financial-row b { font-weight: 700; }
        .final-total { 
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #E5E5EA; 
            font-size: 19px; 
            color: var(--ios-text);
        }
        .final-total span:last-child { color: var(--ios-blue); font-weight: 800; }

        /* Form Inputs */
        .input-table { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--ios-border); 
            border-radius: var(--radius-md); 
            background: #F2F2F7;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-table:focus { border-color: var(--ios-blue); background: white; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 12px; text-transform: uppercase; color: var(--ios-secondary-text); padding: 8px 4px; }
        td { padding: 12px 4px; border-bottom: 1px solid #F2F2F7; }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes modalScale { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #C7C7CC; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ch·∫•m C√¥ng</h2>
    <div id="date-range">Vui l√≤ng t·∫£i file ƒë·ªÉ xem d·ªØ li·ªáu</div>
    <div class="upload-section">
        <input type="file" id="file-input" accept=".xlsx, .xls" />
    </div>
    
    <div class="action-bar" id="action-bar">
        <button class="btn-action btn-salary" onclick="window.openSalaryModal()">üí∞ Nh·∫≠p ƒê∆°n Gi√° L∆∞∆°ng</button>
        <button class="btn-action btn-bonus" onclick="window.openBonusModal()">üéÅ Th∆∞·ªüng & Ghi Ch√∫</button>
        <button class="btn-action btn-penalty" onclick="window.openPenaltyModal()">üö® Danh S√°ch Ph·∫°t Tr·ªÖ</button>
    </div>
    
    <table id="summary-table">
        <tbody id="summary-body"></tbody>
    </table>
</div>

<div id="detail-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAllModals()">&times;</span>
        <h3 id="detail-title" style="text-align:center; font-size: 22px; margin-bottom: 20px;"></h3>
        <div class="attendance-grid" id="detail-grid"></div>
        <div class="financial-summary" id="detail-summary-box"></div>
    </div>
</div>

<div id="salary-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAllModals()">&times;</span>
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px;">ƒê∆°n Gi√° L∆∞∆°ng</h3>
        <table>
            <thead><tr><th>T√™n</th><th>ƒê∆°n gi√° (ƒë/h)</th></tr></thead>
            <tbody id="salary-body"></tbody>
        </table>
    </div>
</div>

<div id="bonus-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAllModals()">&times;</span>
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px;">Th∆∞·ªüng & Ghi Ch√∫</h3>
        <table>
            <thead><tr><th>T√™n</th><th>Th∆∞·ªüng</th><th>Ghi ch√∫</th></tr></thead>
            <tbody id="bonus-body"></tbody>
        </table>
    </div>
</div>

<div id="penalty-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAllModals()">&times;</span>
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px;">Danh S√°ch Ph·∫°t Tr·ªÖ</h3>
        <table style="font-size:12px;">
            <thead><tr><th>T√™n nh√¢n vi√™n</th><th>Chi ti·∫øt vi ph·∫°m</th><th style="text-align:right">T·ªïng ph·∫°t</th></tr></thead>
            <tbody id="penalty-body"></tbody>
        </table>
    </div>
</div>

<script>
    /* PH·∫¶N JAVASCRIPT GI·ªÆ NGUY√äN 100% THEO Y√äU C·∫¶U */
    let allEmployees = [];
    let currentDateHeaders = [];

    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            processAttendance(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: "" }));
        };
        reader.readAsArrayBuffer(file);
    });

    function processAttendance(data) {
        allEmployees = [];
        const headerRow = data.find(r => r.includes(1) && r.includes(2));
        currentDateHeaders = headerRow || [];

        data.forEach((row, i) => {
            if (row.join(" ").includes("Ng√†y :")) document.getElementById('date-range').innerText = row.join(" ").trim();
            if (row.some(c => String(c).includes("ID:"))) {
                let emp = { 
                    id: row[2], name: row[9], attendanceRecords: [], lateDetails: [],
                    stats: { totalMinutes: 0, totalPenalty: 0, cloudPenalty: 0 }, 
                    hourlyRate: 0, bonusAmount: 0, bonusNote: "" 
                };
                allEmployees.push(emp);
                const nextRow = data[i+1];
                if (nextRow) {
                    nextRow.forEach((cell, colIdx) => {
                        const times = String(cell).split(/[\s\n]+/).filter(t => t.includes(':'));
                        if (times.length >= 2) {
                            const firstTime = times[0];
                            const [h, m] = firstTime.split(':').map(Number);
                            const totalMins = h * 60 + m;
                            const morningMark = 425; // 7:05
                            const afternoonMark = 900; // 15:00
                            const targetMark = Math.abs(totalMins - morningMark) < Math.abs(totalMins - afternoonMark) ? morningMark : afternoonMark;
                            const diff = totalMins - targetMark;
                            if (diff >= 1) {
                                const fine = diff > 10 ? 200000 : 100000;
                                emp.stats.totalPenalty += fine;
                                emp.lateDetails.push(`Ng√†y ${currentDateHeaders[colIdx]}: Tr·ªÖ ${diff}p (${firstTime}) - Ph·∫°t ${fine.toLocaleString()}ƒë`);
                            }
                            const [eH, eM] = times[times.length-1].split(':').map(Number);
                            emp.stats.totalMinutes += (eH * 60 + eM) - totalMins;
                            emp.attendanceRecords.push({ day: currentDateHeaders[colIdx], time: times[0] + "\n" + times[times.length-1] });
                        }
                    });
                }
            }
        });
        syncDataAfterUpload();
        displaySummary();
    }

    function syncDataAfterUpload() {
        allEmployees.forEach(emp => {
            const s = window.cloudSalaryData.find(c => c.name === emp.name);
            if (s) emp.hourlyRate = s.hourlyRate;
            const b = window.cloudBonusData.find(c => c.name === emp.name);
            if (b) { emp.bonusAmount = b.bonusAmount; emp.bonusNote = b.bonusNote; }
            if (window.cloudPenaltySummary[emp.name]) {
                emp.stats.cloudPenalty = window.cloudPenaltySummary[emp.name].total;
            }
        });
    }

    function displaySummary() {
        const tbody = document.getElementById('summary-body');
        tbody.innerHTML = '';
        allEmployees.filter(e => e.stats.totalMinutes > 0).forEach((emp) => {
            tbody.innerHTML += `<tr><td>ID: ${emp.id}</td><td class="emp-name-btn" onclick="openDetailModal(${allEmployees.indexOf(emp)})">${emp.name}</td><td>${Math.floor(emp.stats.totalMinutes/60)} gi·ªù c√¥ng</td></tr>`;
        });
        document.getElementById('summary-table').style.display = 'table';
        document.getElementById('action-bar').style.display = 'flex';
    }

    window.openDetailModal = function(idx) {
        const emp = allEmployees[idx];
        document.getElementById('detail-title').innerText = emp.name;
        const grid = document.getElementById('detail-grid');
        grid.innerHTML = '';
        emp.attendanceRecords.forEach(rec => grid.innerHTML += `<div class="date-card"><span class="date-label">Ng√†y ${rec.day}</span><span class="time-label">${rec.time.replace("\n", "<br>")}</span></div>`);

        const base = Math.round((emp.stats.totalMinutes / 60) * emp.hourlyRate);
        const totalFine = emp.stats.totalPenalty + (emp.stats.cloudPenalty || 0);
        const final = base + (emp.bonusAmount || 0) - totalFine;
        
        document.getElementById('detail-summary-box').innerHTML = `
            <div class="financial-row"><span>ƒê∆°n gi√°:</span> <b>${emp.hourlyRate.toLocaleString()} ƒë/h</b></div>
            <div class="financial-row"><span>Th∆∞·ªüng:</span> <b style="color:#34C759">+${emp.bonusAmount.toLocaleString()} ƒë</b></div>
            <div class="financial-row"><span>Ph·∫°t (Tr·ªÖ):</span> <b style="color:#FF3B30">-${totalFine.toLocaleString()} ƒë</b></div>
            <div class="financial-row"><span>L∆∞∆°ng g·ªëc:</span> <b>${base.toLocaleString()} ƒë</b></div>
            <div class="financial-row final-total"><span>L∆Ø∆†NG CU·ªêI:</span> <span>${final.toLocaleString()} ƒë</span></div>
        `;
        document.getElementById('detail-overlay').style.display = 'flex';
    };

    window.openSalaryModal = function() {
        const tbody = document.getElementById('salary-body');
        tbody.innerHTML = '';
        allEmployees.filter(e => e.stats.totalMinutes > 0).forEach(emp => {
            const idx = allEmployees.indexOf(emp);
            tbody.innerHTML += `<tr><td><div style="font-weight:600">${emp.name}</div><div style="font-size:11px;color:#8E8E93">ID: ${emp.id}</div></td><td><input type="number" class="input-table" placeholder="Nh·∫≠p s·ªë..." value="${emp.hourlyRate || ''}" oninput="allEmployees[${idx}].hourlyRate=parseFloat(this.value)||0"></td></tr>`;
        });
        document.getElementById('salary-overlay').style.display = 'flex';
    };

    window.openBonusModal = function() {
        const tbody = document.getElementById('bonus-body');
        tbody.innerHTML = '';
        allEmployees.filter(e => e.stats.totalMinutes > 0).forEach(emp => {
            const idx = allEmployees.indexOf(emp);
            tbody.innerHTML += `<tr><td><div style="font-weight:600">${emp.name}</div></td><td><input type="number" class="input-table" placeholder="Ti·ªÅn..." value="${emp.bonusAmount || ''}" oninput="allEmployees[${idx}].bonusAmount=parseFloat(this.value)||0"></td><td><input type="text" class="input-table" placeholder="L√Ω do..." value="${emp.bonusNote || ''}" oninput="allEmployees[${idx}].bonusNote=this.value"></td></tr>`;
        });
        document.getElementById('bonus-overlay').style.display = 'flex';
    };

    function closeAllModals() { document.querySelectorAll('[id$="-overlay"]').forEach(m => m.style.display = 'none'); }
</script>
</body>
</html>
