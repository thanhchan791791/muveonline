<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Thống Kê Chấm Công & Tính Lương Pro</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV7r-rjXo6U62LX1AA7c7DAHb8GhOOOsg",
            authDomain: "saigon-dalat.firebaseapp.com",
            databaseURL: "https://saigon-dalat-default-rtdb.firebaseio.com",
            projectId: "saigon-dalat",
            storageBucket: "saigon-dalat.firebasestorage.app",
            messagingSenderId: "339735183485",
            appId: "1:339735183485:web:bc23cd740104d272577114",
            measurementId: "G-FDLZXR2X8P"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.cloudBonusData = [];
        window.cloudSalaryData = [];
        window.cloudPenaltySummary = {}; 

        onValue(query(ref(db, 'bonus_records'), limitToLast(1)), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const lastKey = Object.keys(data)[0];
                window.cloudBonusData = data[lastKey].records || [];
                syncDataAfterUpload();
            }
        });

        onValue(query(ref(db, 'salary_config'), limitToLast(1)), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const lastKey = Object.keys(data)[0];
                window.cloudSalaryData = data[lastKey].records || [];
                syncDataAfterUpload();
            }
        });

        onValue(query(ref(db, 'penalty_records'), limitToLast(10)), (snapshot) => {
            window.cloudPenaltySummary = {}; 
            if (snapshot.exists()) {
                const allBatches = snapshot.val();
                Object.values(allBatches).forEach(batch => {
                    if (batch.records) {
                        batch.records.forEach(rec => {
                            if (!window.cloudPenaltySummary[rec.name]) {
                                window.cloudPenaltySummary[rec.name] = { total: 0, details: [] };
                            }
                            window.cloudPenaltySummary[rec.name].total += rec.totalPenalty || 0;
                            if (rec.details) window.cloudPenaltySummary[rec.name].details.push(...rec.details);
                        });
                    }
                });
            }
            syncDataAfterUpload();
        });

        window.saveEmployeesToFirebase = async function() {
            const visibleEmployees = allEmployees.filter(emp => emp.stats.totalMinutes > 0);
            if (visibleEmployees.length === 0) return alert("Không có dữ liệu nhân viên hiển thị!");

            try {
                const snapshot = await get(query(ref(db, 'employee_list'), limitToLast(1)));
                let existingRecords = [];
                
                if (snapshot.exists()) {
                    const lastBatch = Object.values(snapshot.val())[0];
                    existingRecords = lastBatch.records || [];
                }

                const newEmployees = visibleEmployees.filter(visEmp => 
                    !existingRecords.some(exEmp => String(exEmp.id) === String(visEmp.id))
                );

                if (newEmployees.length === 0) {
                    return alert("Không có nhân viên mới nào để thêm!");
                }

                const updatedData = [...existingRecords, ...newEmployees.map(emp => ({ id: emp.id, name: emp.name }))];
                
                await set(ref(db, 'employee_list/List_' + Date.now()), { 
                    records: updatedData, 
                    createdAt: new Date().toLocaleString(),
                    total: updatedData.length,
                    addedCount: newEmployees.length
                });

                alert(`✅ Đã cộng dồn thêm ${newEmployees.length} nhân viên mới!`);
            } catch (error) {
                console.error(error);
                alert("Lỗi khi lưu danh sách!");
            }
        };

        window.saveSalaryToFirebase = function() {
            if (allEmployees.length === 0) return alert("Không có dữ liệu!");
            const data = allEmployees
                .filter(emp => emp.hourlyRate > 0)
                .map(emp => ({ id: emp.id, name: emp.name, hourlyRate: emp.hourlyRate }));
            set(ref(db, 'salary_config/Salary_' + Date.now()), { records: data, createdAt: new Date().toLocaleString() })
            .then(() => alert("✅ Đã lưu!"));
        };

        window.saveBonusToFirebase = function() {
            if (allEmployees.length === 0) return alert("Không có dữ liệu!");
            const data = allEmployees
                .filter(emp => (emp.bonusAmount > 0 || emp.bonusNote !== ""))
                .map(emp => ({ id: emp.id, name: emp.name, bonusAmount: emp.bonusAmount, bonusNote: emp.bonusNote }));
            set(ref(db, 'bonus_records/Bonus_' + Date.now()), { records: data, createdAt: new Date().toLocaleString() })
            .then(() => alert("✅ Đã lưu!"));
        };

        window.savePenaltyToFirebase = function() {
            if (allEmployees.length === 0) return alert("Không có dữ liệu!");
            const data = allEmployees
                .filter(emp => (emp.stats.totalPenalty > 0))
                .map(emp => ({ id: emp.id, name: emp.name, totalPenalty: emp.stats.totalPenalty, details: emp.lateDetails }));
            set(ref(db, 'penalty_records/Penalty_' + Date.now()), { records: data, createdAt: new Date().toLocaleString() })
            .then(() => alert("✅ Đã lưu!"));
        };

        window.openPenaltyModal = function() {
            const tbody = document.getElementById('penalty-body');
            tbody.innerHTML = '';
            allEmployees.forEach(emp => {
                const cloudData = window.cloudPenaltySummary[emp.name] || { total: 0, details: [] };
                const total = emp.stats.totalPenalty + cloudData.total;
                const allDetails = [...new Set([...cloudData.details, ...emp.lateDetails])];
                if (total > 0) {
                    tbody.innerHTML += `<tr><td style="font-weight:600; padding:12px 8px;">${emp.name}</td><td style="font-size:11px; color:#8E8E93;">${allDetails.join('<br>')}</td><td style="color:#FF3B30; font-weight:700; text-align:right;">${total.toLocaleString()}đ</td></tr>`;
                }
            });
            document.getElementById('penalty-overlay').style.display = 'flex';
        };
    </script>

    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-orange: #FF9500;
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.9);
            --ios-text: #1C1C1E;
            --ios-secondary-text: #8E8E93;
            --ios-border: rgba(60, 60, 67, 0.1);
            --radius-xl: 28px;
            --radius-lg: 20px;
            --radius-md: 14px;
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.06);
            --bezier-ios: cubic-bezier(0.32, 0.72, 0, 1);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
        }

        body { 
            background-color: var(--ios-bg); 
            color: var(--ios-text); 
            margin: 0; 
            padding: 20px 16px 100px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        h2 {
            font-size: 34px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 8px;
            padding-left: 4px;
            background: linear-gradient(180deg, #1c1c1e 0%, #48484a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #date-range { 
            font-size: 15px; 
            font-weight: 500;
            color: var(--ios-secondary-text); 
            margin-bottom: 24px; 
            padding-left: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .upload-section { 
            background: var(--ios-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg); 
            padding: 30px 20px; 
            text-align: center; 
            border: 2px dashed var(--ios-border);
            margin-bottom: 24px;
            transition: all 0.3s var(--bezier-ios);
        }
        
        .upload-section:hover {
            border-color: var(--ios-blue);
            background: #fff;
            transform: translateY(-2px);
        }

        .action-bar { 
            display: none; 
            flex-direction: column; 
            gap: 12px; 
            margin-bottom: 24px; 
            animation: slideUp 0.6s var(--bezier-ios);
        }

        .btn-action { 
            width: 100%; 
            padding: 18px; 
            border: none; 
            border-radius: var(--radius-md); 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            color: white; 
            transition: all 0.3s var(--bezier-ios);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-action i { width: 20px; height: 20px; }
        .btn-action:active { transform: scale(0.97); filter: brightness(0.9); }
        
        .btn-salary { background: #1c1c1e; }
        .btn-bonus { background: var(--ios-blue); }
        .btn-penalty { background: var(--ios-red); }
        .btn-save-cloud { background: #34C759; margin-top: 10px; padding: 14px; }

        .stats-container {
            display: none;
            background: var(--ios-card);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--ios-border);
            box-shadow: var(--shadow-soft);
        }
        
        .stats-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--ios-border);
        }

        .stats-list { 
            font-size: 13px; 
            color: var(--ios-text); 
            background: #F2F2F7; 
            padding: 12px; 
            border-radius: 12px; 
            margin-top: 8px;
            border: 1px solid rgba(0,0,0,0.02);
        }

        #summary-table { width: 100%; border-collapse: separate; border-spacing: 0; display: none; }
        #summary-table tr { 
            background: white; 
            border-radius: var(--radius-lg); 
            display: flex;
            flex-direction: column;
            padding: 18px; 
            margin-bottom: 16px; 
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s var(--bezier-ios);
            border: 1px solid var(--ios-border);
        }

        #summary-table tr:hover { transform: scale(1.02); border-color: var(--ios-blue); }

        .emp-name-btn { 
            color: var(--ios-text) !important; 
            font-weight: 800 !important; 
            font-size: 22px !important;
            cursor: pointer; 
            margin: 4px 0 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Modals */
        .modal-content { 
            background: white; 
            border-radius: var(--radius-xl) var(--radius-xl) 0 0; 
            padding: 30px 24px; 
            box-shadow: 0 -15px 50px rgba(0,0,0,0.15);
            animation: sheetUp 0.5s var(--bezier-ios);
        }

        /* PHẦN CẢI TIẾN: DATE CARD NHỎ GỌN */
        .attendance-grid {
            display: grid; 
            grid-template-columns: repeat(6, 1fr); /* Tăng lên 6 cột để chứa nhiều hơn trên 1 hàng */
            gap: 4px; /* Giảm khoảng cách */
            margin-bottom: 20px;
        }

        .date-card { 
            background: #F2F2F7; 
            border-radius: 8px; /* Bo nhỏ hơn */
            padding: 4px 2px; /* Padding cực nhỏ */
            text-align: center;
            transition: all 0.2s;
            border: 0.5px solid rgba(0,0,0,0.05);
        }
        
        .date-card:hover { background: #E5E5EA; transform: scale(1.05); }

        .date-card .day-label {
            font-size: 9px; 
            font-weight: 800; 
            color: #8e8e93; 
            display: block;
            margin-bottom: 1px;
        }

        .date-card .time-label {
            font-size: 8px; 
            color: var(--ios-blue); 
            font-weight: 600; 
            line-height: 1.1;
            display: block;
            white-space: pre-line; /* Để hiển thị xuống hàng của dấu \n */
        }

        .financial-summary { 
            background: #F9F9FB; 
            padding: 24px; 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--ios-border); 
            margin-top: 10px;
        }

        .final-total { 
            margin-top: 18px;
            padding-top: 18px;
            border-top: 2px solid #E5E5EA; 
            font-size: 22px; 
        }

        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .icon-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

<div class="container">
    <h2>Chấm Công</h2>
    <div id="date-range">
        <i data-lucide="calendar"></i> Vui lòng tải file để xem dữ liệu
    </div>

    <div class="upload-section">
        <i data-lucide="cloud-upload" style="width: 48px; height: 48px; color: var(--ios-blue); margin-bottom: 10px;"></i>
        <br>
        <input type="file" id="file-input" accept=".xlsx, .xls" />
    </div>
    
    <div class="stats-container" id="stats-container">
        <h3 style="margin-top:0; font-size:20px; display:flex; align-items:center; gap:8px;">
            <i data-lucide="shield-alert" style="color:var(--ios-red)"></i> Thống Kê Vi Phạm
        </h3>
        <div class="stats-item">
            <div class="stats-header" style="display:flex; justify-content:space-between">
                <span class="stats-label" style="font-weight:600; color:var(--ios-secondary-text)">Đi trễ:</span>
                <span class="stats-value color-red" id="count-late" style="font-weight:700">0 người</span>
            </div>
            <div class="stats-list" id="list-late">Chưa có dữ liệu</div>
        </div>
        <div class="stats-item">
            <div class="stats-header" style="display:flex; justify-content:space-between">
                <span class="stats-label" style="font-weight:600; color:var(--ios-secondary-text)">Mất công (1 lần):</span>
                <span class="stats-value color-orange" id="count-once" style="font-weight:700">0 người</span>
            </div>
            <div class="stats-list" id="list-once">Chưa có dữ liệu</div>
        </div>
        <div class="stats-item" style="border:none">
            <div class="stats-header" style="display:flex; justify-content:space-between">
                <span class="stats-label" style="font-weight:600; color:var(--ios-secondary-text)">Mất công (≥3 lần):</span>
                <span class="stats-value color-red" id="count-triple" style="font-weight:700">0 người</span>
            </div>
            <div class="stats-list" id="list-triple">Chưa có dữ liệu</div>
        </div>
    </div>

    <div class="action-bar" id="action-bar">
        <button class="btn-action btn-salary" onclick="window.openSalaryModal()">
            <i data-lucide="banknote"></i> Nhập Đơn Giá Lương
        </button>
        <button class="btn-action btn-bonus" onclick="window.openBonusModal()">
            <i data-lucide="gift"></i> Thưởng & Ghi Chú
        </button>
        <button class="btn-action btn-penalty" onclick="window.openPenaltyModal()">
            <i data-lucide="octagon-alert"></i> Danh Sách Phạt Trễ
        </button>
    </div>
    
    <table id="summary-table">
        <tbody id="summary-body"></tbody>
    </table>
</div>

<div id="detail-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter:blur(8px); z-index:1000; align-items:center; justify-content:center;">
    <div class="modal-content" style="width:96%; max-width:500px; border-radius:24px; animation: modalScale 0.3s var(--bezier-ios); padding: 20px 12px;">
        <span class="close-btn" onclick="closeAllModals()" style="position:absolute; top:15px; right:15px; font-size:24px; cursor:pointer; color:#ccc; z-index:10;">&times;</span>
        <div class="modal-body" style="max-height:90vh; overflow-y:auto;">
            <h3 id="detail-title" style="text-align:center; font-size: 20px; margin-bottom: 15px;"></h3>
            <div class="attendance-grid" id="detail-grid"></div>
            <div class="financial-summary" id="detail-summary-box"></div>
        </div>
    </div>
</div>

<div id="salary-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px); z-index:1000; align-items:flex-end; justify-content:center;">
    <div class="modal-content" style="width:100%; max-width:600px;">
        <span class="close-btn" onclick="closeAllModals()" style="position:absolute; top:20px; right:20px; font-size:30px; cursor:pointer;">&times;</span>
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px; display:flex; align-items:center; gap:8px;">
            <i data-lucide="dollar-sign"></i> Đơn Giá Lương
        </h3>
        <div style="max-height:50vh; overflow-y:auto;">
            <table style="width:100%">
                <thead><tr style="text-align:left; color:#8e8e93; font-size:12px;"><th>NHÂN VIÊN</th><th>ĐƠN GIÁ (Đ/H)</th></tr></thead>
                <tbody id="salary-body"></tbody>
            </table>
        </div>
        <div class="modal-footer" style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-action btn-save-cloud" style="flex:1" onclick="window.saveSalaryToFirebase()">
                <i data-lucide="save"></i> Lưu Đơn Giá
            </button>
            <button class="btn-action btn-save-cloud" style="flex:1; background:#5856D6;" onclick="window.saveEmployeesToFirebase()">
                <i data-lucide="users"></i> Lưu DS Mới
            </button>
        </div>
    </div>
</div>

<div id="bonus-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px); z-index:1000; align-items:flex-end; justify-content:center;">
    <div class="modal-content" style="width:100%; max-width:600px;">
        <span class="close-btn" onclick="closeAllModals()" style="position:absolute; top:20px; right:20px; font-size:30px; cursor:pointer;">&times;</span>
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px; display:flex; align-items:center; gap:8px;">
            <i data-lucide="sparkles"></i> Thưởng & Ghi Chú
        </h3>
        <div style="max-height:50vh; overflow-y:auto;">
            <table style="width:100%">
                <thead><tr style="text-align:left; color:#8e8e93; font-size:12px;"><th>TÊN</th><th>TIỀN</th><th>GHI CHÚ</th></tr></thead>
                <tbody id="bonus-body"></tbody>
            </table>
        </div>
        <button class="btn-action btn-save-cloud" style="width:100%; margin-top:20px;" onclick="window.saveBonusToFirebase()">
            <i data-lucide="check-circle"></i> Xác Nhận Lưu Thưởng
        </button>
    </div>
</div>

<div id="penalty-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px); z-index:1000; align-items:flex-end; justify-content:center;">
    <div class="modal-content" style="width:100%; max-width:600px;">
        <span class="close-btn" onclick="closeAllModals()" style="position:absolute; top:20px; right:20px; font-size:30px; cursor:pointer;">&times;</span>
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px; display:flex; align-items:center; gap:8px;">
            <i data-lucide="frown"></i> Danh Sách Phạt
        </h3>
        <div style="max-height:50vh; overflow-y:auto;">
            <table style="width:100%">
                <tbody id="penalty-body"></tbody>
            </table>
        </div>
        <button class="btn-action btn-save-cloud" style="width:100%; margin-top:20px; background:var(--ios-red);" onclick="window.savePenaltyToFirebase()">
            <i data-lucide="lock"></i> Chốt Phạt & Lưu Cloud
        </button>
    </div>
</div>

<script>
    let allEmployees = [];
    let currentDateHeaders = [];

    function initIcons() {
        lucide.createIcons();
    }
    initIcons();

    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            processAttendance(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: "" }));
        };
        reader.readAsArrayBuffer(file);
    });

    function processAttendance(data) {
        allEmployees = [];
        const headerRow = data.find(r => r.includes(1) && r.includes(2));
        currentDateHeaders = headerRow || [];

        data.forEach((row, i) => {
            if (row.join(" ").includes("Ngày :")) {
                const dateText = row.join(" ").trim();
                document.getElementById('date-range').innerHTML = `<i data-lucide="calendar"></i> ${dateText}`;
                initIcons();
            }
            if (row.some(c => String(c).includes("ID:"))) {
                let empName = row[9];
                let isThua = String(empName).toLowerCase().trim() === "thua";

                let emp = { 
                    id: row[2], name: empName, attendanceRecords: [], lateDetails: [],
                    onceDays: [], tripleDays: [],
                    stats: { totalMinutes: 0, totalPenalty: 0, cloudPenalty: 0, countOnce: 0, countTriple: 0 }, 
                    hourlyRate: 0, bonusAmount: 0, bonusNote: "" 
                };
                allEmployees.push(emp);
                const nextRow = data[i+1];
                if (nextRow) {
                    nextRow.forEach((cell, colIdx) => {
                        const times = String(cell).split(/[\s\n]+/).filter(t => t.includes(':'));
                        if (times.length > 0) {
                            const dayNum = currentDateHeaders[colIdx];
                            
                            if (times.length === 2) {
                                const [h1, m1] = times[0].split(':').map(Number);
                                const [h2, m2] = times[1].split(':').map(Number);
                                const totalMins = h1 * 60 + m1;
                                
                                if (!isThua) {
                                    const morningMark = 425; 
                                    const afternoonMark = 900; 
                                    const targetMark = Math.abs(totalMins - morningMark) < Math.abs(totalMins - afternoonMark) ? morningMark : afternoonMark;
                                    const diff = totalMins - targetMark;
                                    if (diff >= 1) {
                                        const fine = diff > 10 ? 200000 : 100000;
                                        emp.stats.totalPenalty += fine;
                                        emp.lateDetails.push(`Ngày ${dayNum}: Trễ ${diff}p (${times[0]}) - Phạt ${fine.toLocaleString()}đ`);
                                    }
                                }
                                emp.stats.totalMinutes += (h2 * 60 + m2) - (h1 * 60 + m1);
                                emp.attendanceRecords.push({ day: dayNum, time: times[0] + "\n" + times[1] });
                            } 
                            else if (times.length === 4) {
                                const [h1, m1] = times[0].split(':').map(Number);
                                const [h2, m2] = times[1].split(':').map(Number);
                                const [h3, m3] = times[2].split(':').map(Number);
                                const [h4, m4] = times[3].split(':').map(Number);

                                if (!isThua) {
                                    const firstInMins = h1 * 60 + m1;
                                    const morningMark = 425; 
                                    const diff = firstInMins - morningMark;
                                    if (diff >= 1) {
                                        const fine = diff > 10 ? 200000 : 100000;
                                        emp.stats.totalPenalty += fine;
                                        emp.lateDetails.push(`Ngày ${dayNum}: Trễ ${diff}p (${times[0]}) - Phạt ${fine.toLocaleString()}đ`);
                                    }
                                }

                                const shift1 = (h2 * 60 + m2) - (h1 * 60 + m1);
                                const shift2 = (h4 * 60 + m4) - (h3 * 60 + m3);
                                emp.stats.totalMinutes += (shift1 + shift2);
                                emp.attendanceRecords.push({ day: dayNum, time: times[0] + "→" + times[1] + "\n" + times[2] + "→" + times[3] });
                            }
                            else if (times.length === 1) {
                                emp.stats.countOnce++;
                                emp.onceDays.push(`Ngày ${dayNum} (${times[0]})`);
                                emp.attendanceRecords.push({ day: dayNum, time: times[0] + "\n(Mất công)" });
                            } 
                            else {
                                emp.stats.countTriple++;
                                emp.tripleDays.push(`Ngày ${dayNum} (${times.length} lần)`);
                                emp.attendanceRecords.push({ day: dayNum, time: times.length + " lần\n(Mất công)" });
                            }
                        }
                    });
                }
            }
        });
        syncDataAfterUpload();
        displaySummary();
        displayAdvancedStats();
    }

    function displayAdvancedStats() {
        const lateEmps = allEmployees.filter(e => e.lateDetails.length > 0);
        const onceEmps = allEmployees.filter(e => e.onceDays.length > 0);
        const tripleEmps = allEmployees.filter(e => e.tripleDays.length > 0);

        document.getElementById('list-late').innerHTML = lateEmps.length > 0 ? lateEmps.map(e => `<div style="margin-bottom:5px"><b>${e.name}:</b> ${e.lateDetails.map(d => d.split(':')[0]).join(", ")}</div>`).join("") : "Không có";
        document.getElementById('count-late').innerText = lateEmps.length + " người";

        document.getElementById('list-once').innerHTML = onceEmps.length > 0 ? onceEmps.map(e => `<div style="margin-bottom:5px"><b>${e.name}:</b> ${e.onceDays.join(", ")}</div>`).join("") : "Không có";
        document.getElementById('count-once').innerText = onceEmps.length + " người";

        document.getElementById('list-triple').innerHTML = tripleEmps.length > 0 ? tripleEmps.map(e => `<div style="margin-bottom:5px"><b>${e.name}:</b> ${e.tripleDays.join(", ")}</div>`).join("") : "Không có";
        document.getElementById('count-triple').innerText = tripleEmps.length + " người";

        document.getElementById('stats-container').style.display = 'block';
    }

    function syncDataAfterUpload() {
        allEmployees.forEach(emp => {
            const s = window.cloudSalaryData.find(c => c.name === emp.name);
            if (s) emp.hourlyRate = s.hourlyRate;
            const b = window.cloudBonusData.find(c => c.name === emp.name);
            if (b) { emp.bonusAmount = b.bonusAmount; emp.bonusNote = b.bonusNote; }
            if (window.cloudPenaltySummary[emp.name]) {
                emp.stats.cloudPenalty = window.cloudPenaltySummary[emp.name].total;
            }
        });
    }

    function displaySummary() {
        const tbody = document.getElementById('summary-body');
        tbody.innerHTML = '';
        allEmployees.filter(e => e.attendanceRecords.length > 0).forEach((emp) => {
            tbody.innerHTML += `
                <tr>
                    <td>
                        <div style="font-size:12px; color:#8e8e93; font-weight:600">ID: ${emp.id}</div>
                        <div class="emp-name-btn" onclick="openDetailModal(${allEmployees.indexOf(emp)})">
                            ${emp.name} 
                            <i data-lucide="chevron-right" style="color:#c7c7cc"></i>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <span style="font-size:15px; color:#48484a"><i data-lucide="clock" style="width:14px; vertical-align:middle"></i> ${Math.floor(emp.stats.totalMinutes/60)} giờ công</span>
                            <span style="color:var(--ios-blue); font-weight:700">Chi tiết</span>
                        </div>
                    </td>
                </tr>`;
        });
        document.getElementById('summary-table').style.display = 'table';
        document.getElementById('action-bar').style.display = 'flex';
        initIcons();
    }

    window.openDetailModal = function(idx) {
        const emp = allEmployees[idx];
        document.getElementById('detail-title').innerText = emp.name;
        const grid = document.getElementById('detail-grid');
        grid.innerHTML = '';
        emp.attendanceRecords.forEach(rec => {
            grid.innerHTML += `
                <div class="date-card">
                    <span class="day-label">Ngày ${rec.day}</span>
                    <span class="time-label">${rec.time}</span>
                </div>`;
        });

        const base = Math.round((emp.stats.totalMinutes / 60) * emp.hourlyRate);
        const totalFine = emp.stats.totalPenalty + (emp.stats.cloudPenalty || 0);
        const final = base + (emp.bonusAmount || 0) - totalFine;
        
        document.getElementById('detail-summary-box').innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px;"><span>Đơn giá:</span> <b>${emp.hourlyRate.toLocaleString()} đ/h</b></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; color:var(--ios-green)"><span>Thưởng:</span> <b>+${emp.bonusAmount.toLocaleString()} đ</b></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; color:var(--ios-red)"><span>Phạt:</span> <b>-${totalFine.toLocaleString()} đ</b></div>
            <div class="final-total" style="display:flex; justify-content:space-between; font-weight:800; padding-top:10px; border-top:1px solid #eee;">
                <span>LƯƠNG:</span> 
                <span style="color:var(--ios-blue)">${final.toLocaleString()} đ</span>
            </div>
        `;
        document.getElementById('detail-overlay').style.display = 'flex';
    };

    window.openSalaryModal = function() {
        const tbody = document.getElementById('salary-body');
        tbody.innerHTML = '';
        allEmployees.filter(e => e.attendanceRecords.length > 0).forEach(emp => {
            const idx = allEmployees.indexOf(emp);
            tbody.innerHTML += `<tr><td style="padding:15px 0"><div style="font-weight:600">${emp.name}</div><div style="font-size:11px;color:#8E8E93">ID: ${emp.id}</div></td><td><input type="number" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;" value="${emp.hourlyRate || ''}" oninput="allEmployees[${idx}].hourlyRate=parseFloat(this.value)||0"></td></tr>`;
        });
        document.getElementById('salary-overlay').style.display = 'flex';
        initIcons();
    };

    window.openBonusModal = function() {
        const tbody = document.getElementById('bonus-body');
        tbody.innerHTML = '';
        allEmployees.filter(e => e.attendanceRecords.length > 0).forEach(emp => {
            const idx = allEmployees.indexOf(emp);
            tbody.innerHTML += `<tr><td style="padding:15px 0"><b>${emp.name}</b></td><td><input type="number" style="width:80px; padding:10px; border-radius:10px; border:1px solid #ddd;" value="${emp.bonusAmount || ''}" oninput="allEmployees[${idx}].bonusAmount=parseFloat(this.value)||0"></td><td><input type="text" style="width:100px; padding:10px; border-radius:10px; border:1px solid #ddd;" value="${emp.bonusNote || ''}" oninput="allEmployees[${idx}].bonusNote=this.value"></td></tr>`;
        });
        document.getElementById('bonus-overlay').style.display = 'flex';
        initIcons();
    };

    function closeAllModals() { 
        document.getElementById('detail-overlay').style.display = 'none';
        document.getElementById('salary-overlay').style.display = 'none';
        document.getElementById('bonus-overlay').style.display = 'none';
        document.getElementById('penalty-overlay').style.display = 'none';
    }
</script>
</body>
</html>
